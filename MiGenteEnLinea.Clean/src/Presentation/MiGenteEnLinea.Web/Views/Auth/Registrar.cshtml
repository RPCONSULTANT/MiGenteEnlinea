@{
    ViewData["Title"] = "Registrar";
    Layout = "_LayoutLanding";
}

<style>
    @@media (max-width: 2600px) {
        .divRegistro {
            width: 60%;
            background-color: white;
            height: auto;
            min-height: 600px;
            border-radius: 10px;
            box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25);
            right: 10%;
            top: 250px;
            background-color: white;
            width: 80%;
            position: absolute;
            border-color: black
        }
    }
    
    @@media (max-width: 480px) {
        .divRegistro {
            width: 60%;
            background-color: white;
            height: auto;
            border-radius: 10px;
            box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25);
            right: 2%;
            top: 250px;
            background-color: white;
            width: 95%;
            position: absolute;
            border-color: black;
            margin-bottom: 30px;
        }
    }
</style>

<div class="banner2" style="z-index: 1000">
    <div class="banner-content">
    </div>
    <div class="animate__animated animate__backInDown divRegistro">
        <div class="container" style="margin: 20px,20px,20px,20px;">
            <h4 style="margin-top:10px; font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif" class="headertext">Bienvenido a</h4>
            <h4 style="color: #2C64F8; margin-top: -5px; font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif" class="headertext">Mi Gente en Linea</h4>
            <hr />

            <div class="row">
                <div class="form-row col col-lg-4">
                    <div class="col col-12" style="margin-top: 20px;">
                        <h2 class="col col-lg-6 col-xs-12" style="font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif">Regístrate</h2>
                    </div>
                    <p></p>

                    <div id="perfilForm" class="container">
                        <div id="registerAlert" class="alert" style="display: none;"></div>
                        
                        <form id="formRegistrar" onsubmit="return handleRegister(event)">
                            <div class="form-row align-items-center col col-lg-12 col-xs-12">
                                <div class="col-sm-12 my-1">
                                    <select id="tipo" name="tipo" class="form-control" required>
                                        <option value="">Seleccione el Tipo de Perfil</option>
                                        <option value="1">Empleador</option>
                                        <option value="2">Ofertante/Contratista</option>
                                    </select>
                                </div>
                                <div class="col-sm-6 my-1">
                                    <div class="input-group">
                                        <input type="text" id="nombre" name="nombre" required class="form-control" placeholder="Nombre">
                                    </div>
                                </div>
                                <div class="col-sm-6 my-1">
                                    <div class="input-group">
                                        <input type="text" id="apellido" name="apellido" required class="form-control" placeholder="Apellido">
                                    </div>
                                </div>
                                <div class="col-sm-12 my-1">
                                    <div class="input-group">
                                        <input type="email" id="email" name="email" required class="form-control" placeholder="example@email.com">
                                    </div>
                                </div>
                                <div class="col-sm-6 my-1">
                                    <div class="input-group">
                                        <input type="text" id="telefono1" name="telefono1" required class="form-control" placeholder="Teléfono 1">
                                    </div>
                                </div>
                                <div class="col-sm-6 my-1">
                                    <div class="input-group">
                                        <input type="text" id="telefono2" name="telefono2" class="form-control" placeholder="Teléfono 2">
                                    </div>
                                </div>

                                <div class="col-sm-12 col-lg-12 my-2">
                                    <hr />
                                    <a>Credenciales de Acceso</a>
                                </div>

                                <div class="col-sm-12 my-1">
                                    <label class="sr-only" for="usuario">Username</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text">@@</div>
                                        </div>
                                        <input type="text" id="usuario" name="usuario" required class="form-control" placeholder="Nombre de Usuario">
                                    </div>
                                </div>

                                <div class="col-sm-12 col-lg-12 my-2">
                                    <button type="submit" id="btnRegistrar" class="form-control btn btn-primary">
                                        <span id="registerSpinner" class="spinner-border spinner-border-sm" style="display: none;" role="status"></span>
                                        <span id="registerText">Registrar Cuenta</span>
                                    </button>
                                </div>
                                
                                <div class="col-sm-12 col-lg-12 my-1 text-center">
                                    <a href="@Url.Action("Login", "Auth")" class="text-primary">¿Ya tienes cuenta? Inicia sesión</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="form-row col col-lg-8 bg-primary d-none d-md-block" style="background-image: url(/images/angryimg.png); background-size: cover; border-radius: 20px;">
                    <div class="col col-12" style="margin-top: 31px;">
                        <h2 class="animate__animated animate__slow" style="text-align: center; font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif; color: white">Aquí comienzas a formar parte de nuestra comunidad</h2>
                        <hr />
                        <div class="row">
                            <div class="col col-lg6">
                                <img style="border-radius: 100px; max-width: 100%" class="animate__animated animate__wobble animate__slow" src="/images/x2q8uahp.bmp" />
                            </div>
                            <div class="col col-lg6">
                                <p style="color: white; text-align: center">La comunidad mas completa de profesionales, donde podras gestionar tus empleados y encontrar personal calificado para cubrir tus necesidades.</p>
                                <a href="@Url.Action("Planes", "Home")" class="btn btn-success form-control">Ver Planes</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="form-control" style="background-image: url(/images/back1.jpg); height: 700px;"></div>

@section Scripts {
    <script>
        // API Configuration - usa global API_BASE del custom.js
        const API_BASE_URL = API_BASE;
        
        // ============================================
        // REGISTER HANDLER
        // ============================================
        async function handleRegister(event) {
            event.preventDefault();
            
            // Get form values
            const tipo = document.getElementById('tipo').value;
            const nombre = document.getElementById('nombre').value.trim();
            const apellido = document.getElementById('apellido').value.trim();
            const email = document.getElementById('email').value.trim().toLowerCase();
            const telefono1 = document.getElementById('telefono1').value.trim();
            const telefono2 = document.getElementById('telefono2').value.trim();
            const usuario = document.getElementById('usuario').value.trim();
            
            // Basic validation
            if (!tipo || !nombre || !apellido || !email || !telefono1 || !usuario) {
                showAlert('registerAlert', 'Por favor complete todos los campos requeridos', 'danger');
                return false;
            }
            
            // Email validation
            const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('registerAlert', 'Por favor ingrese un correo electrónico válido', 'danger');
                return false;
            }
            
            setLoading(true);
            hideAlert('registerAlert');
            
            try {
                // Build the registration payload
                // FLUJO LEGACY: No se envía password aquí - se crea en la activación
                const payload = {
                    tipo: parseInt(tipo),
                    nombre: nombre,
                    apellido: apellido,
                    email: email,
                    telefono1: telefono1,
                    telefono2: telefono2 || null,
                    host: window.location.origin  // Host para el link de activación
                };
                
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (response.ok || response.status === 201) {
                    // Success - show message and redirect to login
                    showAlert('registerAlert', '¡Cuenta creada exitosamente! Revise su correo electrónico para activar su cuenta.', 'success');
                    
                    // Clear form
                    document.getElementById('formRegistrar').reset();
                    
                    // Redirect to login after 3 seconds
                    setTimeout(() => {
                        window.location.href = '@Url.Action("Login", "Auth")';
                    }, 3000);
                    
                } else if (response.status === 400) {
                    // Validation error
                    let errorMsg = 'Error de validación';
                    if (data.errors) {
                        // Get first error message
                        const errors = Object.values(data.errors).flat();
                        errorMsg = errors[0] || errorMsg;
                    } else if (data.message) {
                        errorMsg = data.message;
                    } else if (data.title) {
                        errorMsg = data.title;
                    }
                    showAlert('registerAlert', errorMsg, 'danger');
                    
                } else if (response.status === 409) {
                    // Email or user already exists
                    showAlert('registerAlert', 'El correo electrónico o nombre de usuario ya está registrado', 'warning');
                    
                } else {
                    const errorMsg = data.message || data.title || 'Error al registrar la cuenta';
                    showAlert('registerAlert', errorMsg, 'danger');
                }
                
            } catch (error) {
                console.error('Register error:', error);
                showAlert('registerAlert', 'Error de conexión. Verifique que el servidor esté disponible.', 'danger');
            } finally {
                setLoading(false);
            }
            
            return false;
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            // Scroll to alert
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function hideAlert(elementId) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.style.display = 'none';
        }
        
        function setLoading(isLoading) {
            const btn = document.getElementById('btnRegistrar');
            const spinner = document.getElementById('registerSpinner');
            const text = document.getElementById('registerText');
            
            if (btn) btn.disabled = isLoading;
            if (spinner) spinner.style.display = isLoading ? 'inline-block' : 'none';
            if (text) text.textContent = isLoading ? 'Registrando...' : 'Registrar Cuenta';
        }
    </script>
}
