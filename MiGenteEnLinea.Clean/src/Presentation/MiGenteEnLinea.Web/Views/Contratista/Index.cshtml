@*
    Vista Index del Contratista - Administrar Perfil Profesional
    Basado en: FRONT_Publicado/Contratista/index_contratista.aspx
    Tema: Argon Dashboard 2.0 + Bootstrap 5
*@
@{
    ViewData["Title"] = "Mi Perfil";
    Layout = "_LayoutContratista";
}

<style>
    .avatar {
        border-radius: 50%;
        width: 150px;
        height: 150px;
        object-fit: cover;
    }
</style>

<div class="container-fluid py-4">
    <h3 class="text-white mb-4">Administrar Perfil Profesional</h3>

    <div class="row">
        <!-- Columna Foto de Perfil -->
        <div class="col-md-3">
            <div class="card" style="text-align: center;">
                <div class="align-content-center justify-content-center" style="text-align: center; margin-top: 20px;">
                    <img src="https://via.placeholder.com/150" class="card-img-top avatar" id="profileImage" alt="Imagen de perfil">
                </div>
                <div class="card-body">
                    <h5 class="card-title">Imagen de Perfil</h5>
                    <input type="file" class="form-control" id="fileUpload" accept="image/*" />
                    <div class="mb-3" style="display: flex; flex-direction: column; align-items: center; text-align: center; margin-top: 15px;">
                        <label class="form-label">Calificación de Perfil</label>
                        <div class="text-warning fs-4" id="ratingDisplay">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="far fa-star"></i>
                        </div>
                        <span class="text-muted" id="ratingValue">4.0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Datos -->
        <div class="col-md-9 bg-white" style="height: auto">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#datosGenerales">Datos Generales</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#servicios">Catalogo de Servicios</a>
                </li>
            </ul>
            <div class="tab-content">
                <!-- Tab Datos Generales -->
                <div class="tab-pane fade show active" id="datosGenerales">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="titulo" class="form-label">Titulo de Perfil</label>
                                                <input type="text" class="form-control" id="txtTitulo" placeholder="Ingrese el título de su publicación" />
                                            </div>
                                            <div class="mb-3">
                                                <label for="nombre" class="form-label">Sector Profesional</label>
                                                <select class="form-select" id="ddlSector">
                                                    <option value="">-- Seleccione --</option>
                                                    <option value="Electricidad">Electricidad</option>
                                                    <option value="Plomería">Plomería</option>
                                                    <option value="Carpintería">Carpintería</option>
                                                    <option value="Pintura">Pintura</option>
                                                    <option value="Jardinería">Jardinería</option>
                                                    <option value="Limpieza">Limpieza</option>
                                                    <option value="Albañilería">Albañilería</option>
                                                    <option value="Mecánica">Mecánica</option>
                                                    <option value="Cocina">Cocina</option>
                                                    <option value="Cuidado de Niños">Cuidado de Niños</option>
                                                    <option value="Cuidado de Adultos Mayores">Cuidado de Adultos Mayores</option>
                                                    <option value="Otro">Otro</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="comentarios" class="form-label">Presentación</label>
                                                <textarea class="form-control" id="txtPresentacion" rows="4" placeholder="Agregue una breve presentacion para que sus posibles clientes le conozcan mejor."></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="email" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="txtEmail" />
                                            </div>
                                            <div class="mb-3 d-flex flex-row gap-3">
                                                <div class="form-group">
                                                    <label for="experiencia" class="form-label">Años de Experiencia</label>
                                                    <input type="number" class="form-control" id="txtExperiencia" min="0" max="50" style="width: 80px;" />
                                                </div>
                                                <div class="form-group flex-grow-1">
                                                    <label for="prov" class="form-label">Provincia</label>
                                                    <select class="form-select" id="comboProvincias">
                                                        <option value="">-- Seleccione --</option>
                                                        <option value="Distrito Nacional">Distrito Nacional</option>
                                                        <option value="Santo Domingo">Santo Domingo</option>
                                                        <option value="Santiago">Santiago</option>
                                                        <option value="La Vega">La Vega</option>
                                                        <option value="Puerto Plata">Puerto Plata</option>
                                                        <option value="San Cristóbal">San Cristóbal</option>
                                                        <option value="Duarte">Duarte</option>
                                                        <option value="La Romana">La Romana</option>
                                                        <option value="San Pedro de Macorís">San Pedro de Macorís</option>
                                                        <option value="Espaillat">Espaillat</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="row form-group mb-3">
                                                <div class="col-md-6">
                                                    <label for="telefono1" class="form-label">Tipo de Perfil</label>
                                                    <select class="form-select" id="ddlTipoPerfil">
                                                        <option value="1" selected>Persona Fisica</option>
                                                        <option value="2">Empresa</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="telefono2" class="form-label">RNC/Cedula</label>
                                                    <input type="text" class="form-control" id="txtIdentificacion" maxlength="11" />
                                                </div>
                                            </div>
                                            <div class="row form-group mb-3" id="divTipoPersona">
                                                <div class="col-md-6">
                                                    <label for="telefono1" class="form-label">Nombre</label>
                                                    <input type="text" class="form-control" id="txtNombre" />
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="telefono2" class="form-label">Apellido</label>
                                                    <input type="text" class="form-control" id="txtApellido" />
                                                </div>
                                            </div>
                                            <div class="row form-group mb-3" id="divTipoEmpresa" style="display: none;">
                                                <div class="col-md-12">
                                                    <label for="telefono1" class="form-label">Razon Social</label>
                                                    <input type="text" class="form-control" id="txtRazonSocial" />
                                                </div>
                                            </div>
                                            <div class="row form-group mb-3">
                                                <div class="col-md-6">
                                                    <label for="telefono1" class="form-label">Teléfono 1</label>
                                                    <input type="tel" class="form-control" id="txtTelefono1" />
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="telefono2" class="form-label">Whatsapp?</label>
                                                    <div class="form-check mt-2">
                                                        <input class="form-check-input" type="checkbox" id="chkWhatsapp1">
                                                        <label class="form-check-label" for="chkWhatsapp1">Sí</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row form-group mb-3">
                                                <div class="col-md-6">
                                                    <label for="telefono2" class="form-label">Teléfono 2</label>
                                                    <input type="tel" class="form-control" id="txtTelefono2" />
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="telefono2" class="form-label">Whatsapp?</label>
                                                    <div class="form-check mt-2">
                                                        <input class="form-check-input" type="checkbox" id="chkWhatsapp2">
                                                        <label class="form-check-label" for="chkWhatsapp2">Sí</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-secondary">
                                <button type="button" class="btn btn-primary" id="btnGuardar">
                                    <i class="fa fa-save"></i> Guardar Información
                                </button>
                                <button type="button" class="btn btn-success" id="btnActivar" style="display: none;">
                                    <i class="fa fa-check"></i> Activar Perfil
                                </button>
                                <button type="button" class="btn btn-danger" id="btnDesactivar">
                                    <i class="fa fa-times"></i> Desactivar Perfil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Servicios -->
                <div class="tab-pane fade" id="servicios">
                    <br />
                    <label class="form-label">Descripción de Servicio</label>
                    <div class="input-group">
                        <div class="col col-md-10 col-sm-12">
                            <input type="text" class="form-control" id="txtServicio" placeholder="Ingrese la descripcion de servicio que ofrece" />
                        </div>
                        <div class="col col-md-2 col-sm-12 mx-auto">
                            <button type="button" class="btn btn-primary" id="btnAgregar">
                                <i class="fa fa-plus"></i> Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <hr>
                        <h4 class="card-title">Servicios</h4>
                        <div class="form">
                            <div class="mb-3">
                                <table class="table table-hover" id="tablaServicios">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Descripción</th>
                                            <th style="width: 120px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Servicios se agregan dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // API Base URL - Configurar según ambiente
        const API_BASE = 'http://localhost:5015/api';
        
        // Variables globales
        let contratistaId = null;
        let userId = null; // Se obtiene del token JWT o sesión
        let perfilActivo = false;
        
        $(document).ready(function () {
            // Obtener userId del localStorage (asumiendo login previo)
            userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
            
            if (!userId) {
                // Para desarrollo: usar un userId de prueba o redirigir a login
                console.warn('No userId encontrado. Por favor inicie sesión.');
                // window.location.href = '/Auth/Login';
            }
            
            // Cargar perfil al iniciar
            loadPerfil();
            
            // Preview de imagen al seleccionar archivo
            $('#fileUpload').change(function () {
                var input = this;
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $('#profileImage').attr('src', e.target.result);
                    };
                    reader.readAsDataURL(input.files[0]);
                    
                    // TODO: Subir imagen a storage y actualizar URL
                    // uploadImage(input.files[0]);
                }
            });

            // Cambiar entre Persona Fisica y Empresa
            $('#ddlTipoPerfil').on('change', function () {
                if ($(this).val() === '1') {
                    $('#divTipoPersona').show();
                    $('#divTipoEmpresa').hide();
                } else {
                    $('#divTipoPersona').hide();
                    $('#divTipoEmpresa').show();
                }
            });

            // Agregar servicio vía API
            $('#btnAgregar').on('click', function () {
                var servicio = $('#txtServicio').val().trim();
                if (servicio === '') {
                    Swal.fire('Error', 'Ingrese una descripción del servicio', 'warning');
                    return;
                }
                
                if (!contratistaId) {
                    Swal.fire('Error', 'Primero debe guardar su perfil', 'warning');
                    return;
                }
                
                addServicio(servicio);
            });

            // Remover servicio vía API
            $(document).on('click', '.btn-remover', function () {
                var servicioId = $(this).data('servicio-id');
                var row = $(this).closest('tr');
                
                if (servicioId) {
                    removeServicio(servicioId, row);
                } else {
                    row.remove(); // Servicio no guardado aún
                }
            });

            // Guardar información
            $('#btnGuardar').on('click', function () {
                savePerfil();
            });

            // Activar perfil
            $('#btnActivar').on('click', function () {
                activarPerfil();
            });

            // Desactivar perfil
            $('#btnDesactivar').on('click', function () {
                Swal.fire({
                    title: '¿Desactivar perfil?',
                    text: 'Tu perfil no será visible en el directorio.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, desactivar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        desactivarPerfil();
                    }
                });
            });
        });
        
        // ==================== API FUNCTIONS ====================
        
        // Cargar perfil del contratista desde API
        async function loadPerfil() {
            if (!userId) {
                console.log('No userId para cargar perfil');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/contratistas/by-user/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                
                if (response.ok) {
                    const perfil = await response.json();
                    contratistaId = perfil.contratistaId || perfil.id;
                    perfilActivo = perfil.activo;
                    
                    // Llenar campos del formulario
                    $('#txtTitulo').val(perfil.titulo || '');
                    $('#ddlSector').val(perfil.sector || '');
                    $('#txtPresentacion').val(perfil.presentacion || '');
                    $('#txtEmail').val(perfil.email || '');
                    $('#txtExperiencia').val(perfil.experiencia || '');
                    $('#comboProvincias').val(perfil.provincia || '');
                    $('#ddlTipoPerfil').val(perfil.tipo || '1');
                    $('#txtIdentificacion').val(perfil.identificacion || '');
                    $('#txtNombre').val(perfil.nombre || '');
                    $('#txtApellido').val(perfil.apellido || '');
                    $('#txtTelefono1').val(perfil.telefono1 || '');
                    $('#chkWhatsapp1').prop('checked', perfil.whatsapp1 || false);
                    $('#txtTelefono2').val(perfil.telefono2 || '');
                    $('#chkWhatsapp2').prop('checked', perfil.whatsapp2 || false);
                    
                    // Imagen de perfil
                    if (perfil.imagenUrl) {
                        $('#profileImage').attr('src', perfil.imagenUrl);
                    }
                    
                    // Mostrar/ocultar botones según estado
                    updateButtonState();
                    
                    // Toggle Persona/Empresa
                    if (perfil.tipo === 2) {
                        $('#divTipoPersona').hide();
                        $('#divTipoEmpresa').show();
                        $('#txtRazonSocial').val(perfil.nombre || '');
                    } else {
                        $('#divTipoPersona').show();
                        $('#divTipoEmpresa').hide();
                    }
                    
                    // Cargar servicios
                    loadServicios();
                    
                } else if (response.status === 404) {
                    console.log('Perfil de contratista no encontrado. Es un nuevo registro.');
                } else {
                    console.error('Error al cargar perfil:', response.status);
                }
            } catch (error) {
                console.error('Error de conexión:', error);
            }
        }
        
        // Guardar perfil del contratista
        async function savePerfil() {
            const perfilData = {
                titulo: $('#txtTitulo').val().trim(),
                sector: $('#ddlSector').val(),
                experiencia: parseInt($('#txtExperiencia').val()) || null,
                presentacion: $('#txtPresentacion').val().trim(),
                provincia: $('#comboProvincias').val(),
                nivelNacional: false,
                telefono1: $('#txtTelefono1').val().trim(),
                whatsapp1: $('#chkWhatsapp1').is(':checked'),
                telefono2: $('#txtTelefono2').val().trim(),
                whatsapp2: $('#chkWhatsapp2').is(':checked'),
                email: $('#txtEmail').val().trim()
            };
            
            try {
                const response = await fetch(`${API_BASE}/contratistas/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    },
                    body: JSON.stringify(perfilData)
                });
                
                if (response.ok) {
                    Swal.fire({
                        title: 'Perfil Actualizado',
                        text: 'Tu perfil ha sido actualizado correctamente.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'No se pudo guardar el perfil', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'Error de conexión al servidor', 'error');
            }
        }
        
        // Cargar servicios del contratista
        async function loadServicios() {
            if (!contratistaId) return;
            
            try {
                const response = await fetch(`${API_BASE}/contratistas/${contratistaId}/servicios`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                
                if (response.ok) {
                    const servicios = await response.json();
                    renderServicios(servicios);
                }
            } catch (error) {
                console.error('Error al cargar servicios:', error);
            }
        }
        
        // Renderizar servicios en la tabla
        function renderServicios(servicios) {
            const tbody = $('#tablaServicios tbody');
            tbody.empty();
            
            servicios.forEach(servicio => {
                const row = `<tr data-id="${servicio.servicioId}">
                    <td>${servicio.detalleServicio}</td>
                    <td>
                        <button class="btn btn-sm btn-danger btn-remover" data-servicio-id="${servicio.servicioId}">
                            <i class="fa fa-remove"></i> Remover
                        </button>
                    </td>
                </tr>`;
                tbody.append(row);
            });
        }
        
        // Agregar servicio vía API
        async function addServicio(detalleServicio) {
            try {
                const response = await fetch(`${API_BASE}/contratistas/${contratistaId}/servicios`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    },
                    body: JSON.stringify({ detalleServicio: detalleServicio })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Agregar fila a la tabla
                    const row = `<tr data-id="${result.servicioId}">
                        <td>${detalleServicio}</td>
                        <td>
                            <button class="btn btn-sm btn-danger btn-remover" data-servicio-id="${result.servicioId}">
                                <i class="fa fa-remove"></i> Remover
                            </button>
                        </td>
                    </tr>`;
                    $('#tablaServicios tbody').append(row);
                    $('#txtServicio').val('');
                    
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Servicio agregado',
                        showConfirmButton: false,
                        timer: 2000
                    });
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'No se pudo agregar el servicio', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'Error de conexión al servidor', 'error');
            }
        }
        
        // Remover servicio vía API
        async function removeServicio(servicioId, rowElement) {
            try {
                const response = await fetch(`${API_BASE}/contratistas/${contratistaId}/servicios/${servicioId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                
                if (response.ok) {
                    rowElement.remove();
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Servicio eliminado',
                        showConfirmButton: false,
                        timer: 2000
                    });
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'No se pudo eliminar el servicio', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'Error de conexión al servidor', 'error');
            }
        }
        
        // Activar perfil
        async function activarPerfil() {
            try {
                const response = await fetch(`${API_BASE}/contratistas/${userId}/activar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                
                if (response.ok) {
                    perfilActivo = true;
                    updateButtonState();
                    Swal.fire({
                        title: 'Perfil Activado',
                        text: 'Todos los miembros de la comunidad podrán ver tu perfil en el directorio.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'No se pudo activar el perfil', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'Error de conexión al servidor', 'error');
            }
        }
        
        // Desactivar perfil
        async function desactivarPerfil() {
            try {
                const response = await fetch(`${API_BASE}/contratistas/${userId}/desactivar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                
                if (response.ok) {
                    perfilActivo = false;
                    updateButtonState();
                    Swal.fire({
                        title: 'Perfil Desactivado',
                        text: 'Nadie podrá ver tu perfil publicado en el directorio.',
                        icon: 'info',
                        confirmButtonText: 'OK'
                    });
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'No se pudo desactivar el perfil', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'Error de conexión al servidor', 'error');
            }
        }
        
        // Actualizar estado de botones
        function updateButtonState() {
            if (perfilActivo) {
                $('#btnActivar').hide();
                $('#btnDesactivar').show();
            } else {
                $('#btnActivar').show();
                $('#btnDesactivar').hide();
            }
        }
    </script>
}
