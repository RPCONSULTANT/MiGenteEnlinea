@*
    Vista MisCalificaciones del Contratista
    Basado en: Codigo Fuente Mi Gente/MiGente_Front/Contratista/MisCalificaciones.aspx
    Tema: Argon Dashboard 2.0 + Bootstrap 5
*@
@{
    ViewData["Title"] = "Mis Calificaciones";
    Layout = "_LayoutContratista";
}

<div class="container-fluid py-4">
    <div class="pagetitle">
        <h1 class="text-dark">Consulta Tus Calificaciones</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Mis Calificaciones</a></li>
            </ol>
        </nav>
    </div>

    <div class="container mt-1">
        <div class="section-title justify-content-center" style="text-align: center; overflow-wrap:normal">
        </div>
        <div class="row text-center justify-content-center">
            <div class="col-md-6 mt-3">
                <div class="card text-center shadow">
                    <div class="card-body">
                        <h5 class="card-title">Consulta tu Perfil</h5>
                        <i class="fa fa-star fa-3x text-warning mb-3"></i>
                        <p class="card-text">Conoce como te han calificado tus contratantes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-5 align-content-center" style="text-align: center">
        <h3>Mis calificaciones</h3>

        <div class="table-responsive mt-3">
            <table class="table table-hover table-striped" id="tablaCalificaciones">
                <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Calificador</th>
                        <th class="text-center">Puntualidad</th>
                        <th class="text-center">Conocimientos</th>
                        <th class="text-center">Cumplimiento</th>
                        <th class="text-center">Recomendación</th>
                    </tr>
                </thead>
                <tbody>
                    @* Los datos se cargarían desde la API *@
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fa fa-star-o fa-3x mb-3"></i>
                            <br />
                            Aún no tienes calificaciones.
                            <br />
                            <small>Las calificaciones aparecerán aquí cuando los empleadores evalúen tu trabajo.</small>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // API Base URL viene del global custom.js
        
        // Función para renderizar estrellas
        function renderStars(rating) {
            var stars = '';
            for (var i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fa fa-star text-warning"></i>';
                } else {
                    stars += '<i class="far fa-star text-warning"></i>';
                }
            }
            return stars;
        }

        $(document).ready(function () {
            loadCalificaciones();
        });
        
        // Cargar calificaciones del contratista desde API
        async function loadCalificaciones() {
            const userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
            
            if (!userId) {
                console.warn('No userId encontrado');
                return;
            }
            
            try {
                // Primero obtener la cédula del contratista
                const cedulaResponse = await authenticatedFetch(`/contratistas/cedula/${userId}`);
                
                if (!cedulaResponse.ok) {
                    console.log('No se pudo obtener cédula del contratista');
                    return;
                }
                
                const cedula = await cedulaResponse.text();
                
                // Cargar calificaciones por cédula
                const response = await authenticatedFetch(`/calificaciones/contratista/${cedula}?pageSize=50`);
                
                if (response.ok) {
                    const data = await response.json();
                    renderCalificaciones(data.items || []);
                } else {
                    console.error('Error al cargar calificaciones:', response.status);
                }
            } catch (error) {
                console.error('Error de conexión:', error);
            }
        }
        
        // Renderizar calificaciones en la tabla
        function renderCalificaciones(calificaciones) {
            const tbody = $('#tablaCalificaciones tbody');
            tbody.empty();
            
            if (calificaciones.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fa fa-star-o fa-3x mb-3"></i>
                            <br />
                            Aún no tienes calificaciones.
                            <br />
                            <small>Las calificaciones aparecerán aquí cuando los empleadores evalúen tu trabajo.</small>
                        </td>
                    </tr>
                `);
                return;
            }
            
            calificaciones.forEach(function(c) {
                const fecha = c.fecha ? new Date(c.fecha).toLocaleDateString('es-DO') : '-';
                const calificador = c.nombreEmpleador || c.empleadorUserId || 'Anónimo';
                
                const row = `<tr>
                    <td>${fecha}</td>
                    <td>${calificador}</td>
                    <td class="text-center">${renderStars(c.puntualidad || 0)}</td>
                    <td class="text-center">${renderStars(c.conocimientos || 0)}</td>
                    <td class="text-center">${renderStars(c.cumplimiento || 0)}</td>
                    <td class="text-center">${renderStars(c.recomendacion || 0)}</td>
                </tr>`;
                tbody.append(row);
            });
        }
    </script>
}
