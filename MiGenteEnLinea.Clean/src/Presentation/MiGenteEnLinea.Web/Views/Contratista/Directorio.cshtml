@{
    ViewData["Title"] = "Directorio de Empleadores";
    Layout = "_LayoutContratista";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="pagetitle">
                <h1>Directorio de Empleadores</h1>
                <nav>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Contratista</a></li>
                        <li class="breadcrumb-item active">Directorio</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Filtros de búsqueda -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Buscar Empleador</label>
                            <input type="text" class="form-control" id="txtBuscar" placeholder="Nombre o empresa...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Sector</label>
                            <select class="form-select" id="ddlSector">
                                <option value="">Todos los sectores</option>
                                <option value="comercio">Comercio</option>
                                <option value="servicios">Servicios</option>
                                <option value="construccion">Construcción</option>
                                <option value="manufactura">Manufactura</option>
                                <option value="hogar">Hogar</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Zona</label>
                            <select class="form-select" id="ddlZona">
                                <option value="">Todas las zonas</option>
                                <option value="DN">Distrito Nacional</option>
                                <option value="SD">Santo Domingo</option>
                                <option value="SN">Santiago</option>
                                <option value="LP">La Vega</option>
                                <option value="PP">Puerto Plata</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" id="btnBuscar">
                                <i class="fa fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados -->
    <div class="row" id="resultadosContainer">
        <!-- Los empleadores se cargarán dinámicamente desde el API -->
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando empleadores...</p>
        </div>
    </div>

    <!-- Paginación -->
    <div class="row">
        <div class="col-12">
            <nav aria-label="Navegación de páginas">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1">Anterior</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#">Siguiente</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Modal Ver Empleador -->
<div class="modal fade" id="modalEmpleador" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fa fa-building"></i> Perfil del Empleador</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="rounded-circle bg-primary text-white d-inline-flex justify-content-center align-items-center mb-3" style="width: 120px; height: 120px;">
                            <i class="fa fa-building fa-3x"></i>
                        </div>
                        <h4 id="modalNombre">Constructora ABC, SRL</h4>
                        <p class="text-muted" id="modalSector">Construcción</p>
                        <div class="text-warning">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="far fa-star"></i>
                            <span class="text-dark ms-2">4.0</span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <table class="table">
                            <tr>
                                <th>RNC/Cédula:</th>
                                <td id="modalRNC">123456789</td>
                            </tr>
                            <tr>
                                <th>Ubicación:</th>
                                <td id="modalUbicacion">Distrito Nacional</td>
                            </tr>
                            <tr>
                                <th>Teléfono:</th>
                                <td id="modalTelefono">809-555-0123</td>
                            </tr>
                            <tr>
                                <th>Email:</th>
                                <td id="modalEmail">contacto@empresa.com</td>
                            </tr>
                            <tr>
                                <th>Miembro desde:</th>
                                <td id="modalMiembro">Enero 2024</td>
                            </tr>
                            <tr>
                                <th>Contrataciones realizadas:</th>
                                <td id="modalContrataciones">15</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a href="#" class="btn btn-success" id="btnContactar">
                    <i class="fab fa-whatsapp"></i> Contactar
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // API Base URL - usar del layout o fallback a localhost
        const API_BASE = window.API_BASE || 'http://localhost:5015/api';
        
        let empleadores = [];
        const iconos = ['fa-building', 'fa-home', 'fa-store', 'fa-utensils', 'fa-cogs', 'fa-user', 'fa-industry'];
        const colores = ['primary', 'success', 'info', 'warning', 'danger', 'secondary', 'dark'];

        $(document).ready(function() {
            // Cargar catálogos desde Custom.js
            loadSectores('ddlSector', 'Todos los sectores');
            loadProvincias('ddlZona', 'Todas las zonas');

            // Cargar empleadores al inicio
            cargarEmpleadores();

            // Buscar con filtros
            $('#btnBuscar').on('click', cargarEmpleadores);

            // Buscar al presionar Enter en el campo de búsqueda
            $('#txtBuscar').on('keypress', function(e) {
                if (e.which === 13) cargarEmpleadores();
            });

            // Ver empleador (event delegation)
            $(document).on('click', '.btn-ver-empleador', function() {
                const id = $(this).data('id');
                mostrarModal(id);
            });
        });

        async function cargarEmpleadores() {
            try {
                // Mostrar loading
                $('#resultadosContainer').html(
                    '<div class="col-12 text-center py-5">' +
                    '    <div class="spinner-border text-primary" role="status">' +
                    '        <span class="visually-hidden">Cargando...</span>' +
                    '    </div>' +
                    '    <p class="mt-3 text-muted">Cargando empleadores...</p>' +
                    '</div>'
                );

                // Obtener filtros
                const searchTerm = $('#txtBuscar').val().trim();
                const sector = $('#ddlSector').val();
                const zona = $('#ddlZona').val();

                // Construir URL con query params
                let url = `${API_BASE}/empleadores?soloActivos=true`;
                if (searchTerm) url += `&searchTerm=${encodeURIComponent(searchTerm)}`;
                if (sector) url += `&sector=${encodeURIComponent(sector)}`;
                if (zona) url += `&provincia=${encodeURIComponent(zona)}`;

                // Obtener token JWT
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('No token found. Redirecting to login...');
                    window.location.href = '/Auth/Login';
                    return;
                }

                // Llamar al API con autenticación
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // Manejar sesión expirada
                if (response.status === 401) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Sesión expirada',
                        text: 'Por favor inicie sesión nuevamente',
                        confirmButtonText: 'Ir a login'
                    }).then(() => {
                        window.location.href = '/Auth/Login';
                    });
                    return;
                }

                if (!response.ok) throw new Error('Error al cargar empleadores');

                const result = await response.json();
                
                // El API devuelve un objeto con estructura: { empleadores: [], totalRecords: 0, pageIndex: 1, pageSize: 10, totalPages: 1 }
                empleadores = result.empleadores || [];
                renderEmpleadores(empleadores);

            } catch (error) {
                console.error('Error:', error);
                $('#resultadosContainer').html(
                    '<div class="col-12">' +
                    '    <div class="alert alert-danger" role="alert">' +
                    '        <i class="fa fa-exclamation-triangle"></i> ' +
                    '        Error al cargar empleadores. Por favor intente nuevamente.' +
                    '    </div>' +
                    '</div>'
                );
            }
        }

        function renderEmpleadores(items) {
            if (!items || items.length === 0) {
                $('#resultadosContainer').html(
                    '<div class="col-12">' +
                    '    <div class="alert alert-info text-center" role="alert">' +
                    '        <i class="fa fa-info-circle"></i> ' +
                    '        No se encontraron empleadores con los criterios de búsqueda.' +
                    '    </div>' +
                    '</div>'
                );
                return;
            }

            let html = '';
            items.forEach((emp, index) => {
                const icono = iconos[index % iconos.length];
                const color = colores[index % colores.length];
                const rating = emp.promedioCalificaciones || 0;
                const badgeStatus = emp.activo ? 'bg-success' : 'bg-secondary';
                const statusText = emp.activo ? 'Activo' : 'Inactivo';

                html += `
                    <div class="col-md-4 mb-4">
                        <div class="card shadow h-100">
                            <div class="card-body text-center">
                                <div class="rounded-circle bg-${color} text-white d-inline-flex justify-content-center align-items-center mb-3" style="width: 80px; height: 80px;">
                                    <i class="fa ${icono} fa-2x"></i>
                                </div>
                                <h5 class="card-title">${emp.nombreComercial || emp.nombreCompleto || 'Sin nombre'}</h5>
                                <p class="text-muted mb-2"><i class="fa fa-map-marker-alt"></i> ${emp.provincia || 'N/A'}</p>
                                <p class="text-muted mb-2"><i class="fa fa-industry"></i> ${emp.sector || 'N/A'}</p>
                                <div class="text-warning mb-3">
                                    ${renderStars(rating)}
                                    <span class="text-dark ms-2">${rating.toFixed(1)}</span>
                                </div>
                                <span class="badge ${badgeStatus} mb-3">${statusText}</span>
                                <div class="d-grid">
                                    <button class="btn btn-outline-primary btn-ver-empleador" data-id="${emp.empleadorId}">
                                        <i class="fa fa-eye"></i> Ver Perfil
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            $('#resultadosContainer').html(html);
        }

        function mostrarModal(empleadorId) {
            const empleador = empleadores.find(e => e.empleadorId === empleadorId);
            if (!empleador) return;

            // Llenar modal con datos reales
            $('#modalNombre').text(empleador.nombreComercial || empleador.nombreCompleto || 'Sin nombre');
            $('#modalSector').text(empleador.sector || 'N/A');
            $('#modalRNC').text(empleador.rnc || empleador.cedula || 'N/A');
            $('#modalUbicacion').text(`${empleador.provincia || 'N/A'}${empleador.ciudad ? ', ' + empleador.ciudad : ''}`);
            $('#modalTelefono').text(empleador.telefono1 || empleador.telefono2 || 'N/A');
            $('#modalEmail').text(empleador.email || 'N/A');
            $('#modalMiembro').text(formatDate(empleador.fechaIngreso));
            $('#modalContrataciones').text(empleador.totalContrataciones || 0);

            // Actualizar WhatsApp link
            const whatsapp = empleador.whatsapp1 || empleador.whatsapp2;
            if (whatsapp) {
                $('#btnContactar').attr('href', `https://wa.me/${whatsapp.replace(/\D/g, '')}`);
                $('#btnContactar').show();
            } else {
                $('#btnContactar').hide();
            }

            // Mostrar modal
            $('#modalEmpleador').modal('show');
        }
    </script>
}
