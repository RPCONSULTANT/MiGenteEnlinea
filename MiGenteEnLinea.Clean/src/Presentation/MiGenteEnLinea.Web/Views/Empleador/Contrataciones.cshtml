@{
    ViewData["Title"] = "Contrataciones Temporales - Mi Gente en Línea";
    Layout = "_LayoutEmpleador";
}

<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0">
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Empleador")" class="text-primary">
                <i class="fas fa-home me-1"></i>Dashboard
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="fas fa-handshake me-1"></i>Contrataciones Temporales
        </li>
    </ol>
</nav>

<div class="container-fluid bg-white pt-3 pb-4" style="border-radius: 10px; box-shadow: 0 2px 12px 0 rgba(0,0,0,.1);">
    
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1" style="font-family: 'Open Sans', sans-serif; font-weight: 600;">
                <i class="fas fa-handshake text-primary me-2"></i>Contrataciones Temporales
            </h2>
            <p class="text-muted mb-0">Gestiona tus contrataciones de servicios con proveedores independientes</p>
        </div>
        <div class="d-flex gap-2">
            <a href="@Url.Action("Index", "Empleador")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-gradient-warning text-white">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-sm mb-0 text-uppercase font-weight-bold opacity-8">Pendientes</p>
                            <h3 class="font-weight-bolder mb-0" id="statPendientes">0</h3>
                        </div>
                        <div class="icon icon-shape bg-white shadow text-center rounded-circle">
                            <i class="fas fa-clock text-warning text-lg opacity-10"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-info text-white">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-sm mb-0 text-uppercase font-weight-bold opacity-8">En Progreso</p>
                            <h3 class="font-weight-bolder mb-0" id="statActivas">0</h3>
                        </div>
                        <div class="icon icon-shape bg-white shadow text-center rounded-circle">
                            <i class="fas fa-spinner text-info text-lg opacity-10"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-success text-white">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-sm mb-0 text-uppercase font-weight-bold opacity-8">Completadas</p>
                            <h3 class="font-weight-bolder mb-0" id="statCompletadas">0</h3>
                        </div>
                        <div class="icon icon-shape bg-white shadow text-center rounded-circle">
                            <i class="fas fa-check-circle text-success text-lg opacity-10"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="text-sm mb-0 text-uppercase font-weight-bold opacity-8">Total Invertido</p>
                            <h3 class="font-weight-bolder mb-0" id="statMonto">RD$ 0</h3>
                        </div>
                        <div class="icon icon-shape bg-white shadow text-center rounded-circle">
                            <i class="fas fa-dollar-sign text-primary text-lg opacity-10"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-pills nav-fill mb-3 bg-light p-2 rounded" id="tabsContrataciones" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active d-flex align-items-center justify-content-center" id="pendientes-tab" 
                    data-bs-toggle="tab" data-bs-target="#tabPendientes" type="button" role="tab">
                <i class="fas fa-clock me-2"></i>
                <span>Pendientes</span>
                <span class="badge bg-warning ms-2" id="badgePendientes">0</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center justify-content-center" id="enProgreso-tab" 
                    data-bs-toggle="tab" data-bs-target="#tabEnProgreso" type="button" role="tab">
                <i class="fas fa-spinner me-2"></i>
                <span>En Progreso</span>
                <span class="badge bg-info ms-2" id="badgeActivas">0</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center justify-content-center" id="completadas-tab" 
                    data-bs-toggle="tab" data-bs-target="#tabCompletadas" type="button" role="tab">
                <i class="fas fa-check-circle me-2"></i>
                <span>Completadas</span>
                <span class="badge bg-success ms-2" id="badgeCompletadas">0</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link d-flex align-items-center justify-content-center" id="canceladas-tab" 
                    data-bs-toggle="tab" data-bs-target="#tabCanceladas" type="button" role="tab">
                <i class="fas fa-times-circle me-2"></i>
                <span>Canceladas</span>
                <span class="badge bg-secondary ms-2" id="badgeCanceladas">0</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="tabContent">
        <!-- Tab Pendientes -->
        <div class="tab-pane fade show active" id="tabPendientes" role="tabpanel">
            <!-- Action Buttons -->
            <div class="d-flex flex-wrap gap-2 mb-3">
                <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalNuevaContratacion">
                    <i class="fas fa-plus me-1"></i>Nueva Contratación
                </button>
                <button class="btn btn-outline-secondary" type="button" onclick="loadContrataciones()">
                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                </button>
            </div>

            <!-- Search Box -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" class="form-control" id="searchPendientes" placeholder="Buscar por descripción...">
                    </div>
                </div>
            </div>

            <!-- Grid Pendientes -->
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Contrataciones Pendientes de Aprobación</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th scope="col" class="text-uppercase text-xs font-weight-bolder">ID</th>
                                <th scope="col" class="text-uppercase text-xs font-weight-bolder">Descripción</th>
                                <th scope="col" class="text-uppercase text-xs font-weight-bolder">Fecha Inicio</th>
                                <th scope="col" class="text-uppercase text-xs font-weight-bolder">Fecha Fin</th>
                                <th scope="col" class="text-uppercase text-xs font-weight-bolder text-end">Monto</th>
                                <th scope="col" class="text-uppercase text-xs font-weight-bolder text-center">Estado</th>
                                <th scope="col" class="text-uppercase text-xs font-weight-bolder text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyPendientes">
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3 d-block"></i>
                                    <span class="text-muted">Cargando contrataciones...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab En Progreso -->
        <div class="tab-pane fade" id="tabEnProgreso" role="tabpanel">
            <div class="d-flex flex-wrap gap-2 mb-3">
                <button class="btn btn-outline-secondary" type="button" onclick="loadContrataciones()">
                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                </button>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" class="form-control" id="searchActivas" placeholder="Buscar...">
                    </div>
                </div>
            </div>
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="mb-0"><i class="fas fa-spinner me-2"></i>Trabajos En Progreso</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>ID</th>
                                <th>Descripción</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Fin Est.</th>
                                <th class="text-end">Monto</th>
                                <th class="text-center">Avance</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyActivas">
                            <tr>
                                <td colspan="7" class="text-center py-5 text-muted">
                                    <i class="fas fa-briefcase fa-2x mb-3 d-block"></i>
                                    No hay trabajos en progreso
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Completadas -->
        <div class="tab-pane fade" id="tabCompletadas" role="tabpanel">
            <div class="d-flex flex-wrap gap-2 mb-3">
                <a href="@Url.Action("Calificaciones", "Empleador")" class="btn btn-warning">
                    <i class="fas fa-star me-1"></i>Calificar Pendientes
                </a>
                <button class="btn btn-outline-secondary" type="button" onclick="loadContrataciones()">
                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                </button>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" class="form-control" id="searchCompletadas" placeholder="Buscar...">
                    </div>
                </div>
            </div>
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Trabajos Completados</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>ID</th>
                                <th>Descripción</th>
                                <th>Fechas</th>
                                <th class="text-end">Monto</th>
                                <th class="text-center">Calificación</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyCompletadas">
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <i class="fas fa-check-circle fa-2x mb-3 d-block"></i>
                                    No hay trabajos completados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Canceladas -->
        <div class="tab-pane fade" id="tabCanceladas" role="tabpanel">
            <div class="d-flex flex-wrap gap-2 mb-3">
                <button class="btn btn-outline-secondary" type="button" onclick="loadContrataciones()">
                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                </button>
            </div>
            <div class="card shadow-sm">
                <div class="card-header bg-light py-2">
                    <h6 class="mb-0"><i class="fas fa-times-circle me-2"></i>Contrataciones Canceladas</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>ID</th>
                                <th>Descripción</th>
                                <th>Fecha Cancelación</th>
                                <th class="text-end">Monto</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyCanceladas">
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="fas fa-times-circle fa-2x mb-3 d-block"></i>
                                    No hay contrataciones canceladas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Contratación -->
<div class="modal fade" id="modalNuevaContratacion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Nueva Contratación Temporal
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Alert para mensajes -->
                <div id="contratacionAlert" class="alert d-none" role="alert"></div>

                <form id="formNuevaContratacion">
                    <!-- Sección: Información del Trabajo -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0"><i class="fas fa-briefcase me-2 text-primary"></i>Información del Trabajo</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">Descripción Breve <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="descripcionCorta" maxlength="60" 
                                           placeholder="Ej: Reparación de plomería - Baño principal" required>
                                    <small class="text-muted"><span id="descripcionCortaCount">0</span>/60 caracteres</small>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">Descripción Detallada</label>
                                    <textarea class="form-control" id="descripcionAmpliada" rows="3" maxlength="250"
                                              placeholder="Detalles adicionales del trabajo, materiales, alcance..."></textarea>
                                    <small class="text-muted"><span id="descripcionAmpliadaCount">0</span>/250 caracteres</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Fechas y Monto -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0"><i class="fas fa-calendar-alt me-2 text-success"></i>Fechas y Monto</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Fecha Inicio <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="fechaInicio" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Fecha Fin Estimada <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="fechaFin" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Monto Acordado <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text">RD$</span>
                                        <input type="text" class="form-control" id="montoAcordado" 
                                               placeholder="0.00" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Esquema de Pagos</label>
                                    <select class="form-select" id="esquemaPagos">
                                        <option value="">-- Seleccione --</option>
                                        <option value="Pago único al finalizar">Pago único al finalizar</option>
                                        <option value="50% adelanto, 50% al finalizar">50% adelanto, 50% al finalizar</option>
                                        <option value="Por etapas completadas">Por etapas completadas</option>
                                        <option value="Semanal">Semanal</option>
                                        <option value="Quincenal">Quincenal</option>
                                        <option value="Otro">Otro (especificar en notas)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Notas Adicionales</label>
                                    <input type="text" class="form-control" id="notas" maxlength="500"
                                           placeholder="Cualquier observación adicional...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Términos -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="chkTerminos" required>
                        <label class="form-check-label" for="chkTerminos">
                            Acepto los <a href="#" target="_blank">términos y condiciones</a> de contratación temporal
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnGuardarContratacion">
                    <i class="fas fa-save me-1"></i>Crear Contratación
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalle Contratación -->
<div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Detalle de Contratación #<span id="detalleId"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detalleBody">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer" id="detalleFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = 'http://localhost:5015/api';
        
        // Variables globales para datos
        let allPendientes = [];
        let allActivas = [];
        let allCompletadas = [];
        let allCanceladas = [];
        
        // ============================================
        // INICIALIZACIÓN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadContrataciones();
            initFormEvents();
        });
        
        function getAuthToken() {
            return localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
        }
        
        // ============================================
        // CARGAR CONTRATACIONES
        // ============================================
        async function loadContrataciones() {
            const token = getAuthToken();
            if (!token) {
                showNoAuth();
                return;
            }
            
            try {
                // Cargar todas las contrataciones
                const response = await fetch(`${API_BASE_URL}/contrataciones?pageSize=100`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // API returns array directly, not paginated object
                    const items = Array.isArray(data) ? data : (data.items || data || []);
                    
                    // Clasificar por estado
                    // Estados: 1=Pendiente, 2=Aceptada, 3=En Progreso, 4=Completada, 5=Cancelada, 6=Rechazada
                    allPendientes = items.filter(c => c.estatus === 1 || c.estatus === 2);
                    allActivas = items.filter(c => c.estatus === 3);
                    allCompletadas = items.filter(c => c.estatus === 4);
                    allCanceladas = items.filter(c => c.estatus === 5 || c.estatus === 6);
                    
                    // Actualizar estadísticas
                    updateStats();
                    
                    // Renderizar tablas
                    renderPendientes();
                    renderActivas();
                    renderCompletadas();
                    renderCanceladas();
                    
                    console.log(`Contrataciones cargadas: ${items.length} total`);
                } else if (response.status === 401) {
                    showNoAuth();
                } else {
                    console.error('Error loading contrataciones:', response.status);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error de conexión');
            }
        }
        
        function updateStats() {
            document.getElementById('statPendientes').textContent = allPendientes.length;
            document.getElementById('statActivas').textContent = allActivas.length;
            document.getElementById('statCompletadas').textContent = allCompletadas.length;
            document.getElementById('badgePendientes').textContent = allPendientes.length;
            document.getElementById('badgeActivas').textContent = allActivas.length;
            document.getElementById('badgeCompletadas').textContent = allCompletadas.length;
            document.getElementById('badgeCanceladas').textContent = allCanceladas.length;
            
            // Calcular total invertido (solo completadas)
            const totalMonto = allCompletadas.reduce((sum, c) => sum + (c.montoAcordado || 0), 0);
            document.getElementById('statMonto').textContent = 'RD$ ' + totalMonto.toLocaleString('en-US', {minimumFractionDigits: 0});
        }
        
        function showNoAuth() {
            const message = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <i class="fas fa-lock fa-2x text-danger mb-3 d-block"></i>
                        <span class="text-muted">Sesión expirada. <a href="@Url.Action("Login", "Auth")">Iniciar sesión</a></span>
                    </td>
                </tr>
            `;
            document.getElementById('tbodyPendientes').innerHTML = message;
        }
        
        function showError(msg) {
            document.getElementById('tbodyPendientes').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <i class="fas fa-exclamation-circle fa-2x text-danger mb-3 d-block"></i>
                        <span class="text-muted">${msg}. <button class="btn btn-link p-0" onclick="loadContrataciones()">Reintentar</button></span>
                    </td>
                </tr>
            `;
        }
        
        // ============================================
        // RENDERIZAR TABLAS
        // ============================================
        function renderPendientes() {
            const tbody = document.getElementById('tbodyPendientes');
            
            if (!allPendientes.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <i class="fas fa-clock fa-2x text-muted mb-3 d-block"></i>
                            <span class="text-muted">No hay contrataciones pendientes</span>
                            <br><small class="text-primary">Haz clic en "Nueva Contratación" para crear una</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allPendientes.map(c => `
                <tr>
                    <td><span class="badge bg-light text-dark">#${c.detalleId}</span></td>
                    <td>
                        <strong>${c.descripcionCorta || 'Sin descripción'}</strong>
                    </td>
                    <td>${formatDate(c.fechaInicio)}</td>
                    <td>${formatDate(c.fechaFinal)}</td>
                    <td class="text-end">
                        <strong class="text-success">RD$ ${(c.montoAcordado || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-${getStatusBadge(c.estatus)}">${c.nombreEstado || getStatusName(c.estatus)}</span>
                    </td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${c.detalleId})" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="iniciarTrabajo(${c.detalleId})" title="Iniciar trabajo">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelarContratacion(${c.detalleId})" title="Cancelar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderActivas() {
            const tbody = document.getElementById('tbodyActivas');
            
            if (!allActivas.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <i class="fas fa-briefcase fa-2x text-muted mb-3 d-block"></i>
                            <span class="text-muted">No hay trabajos en progreso</span>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allActivas.map(c => `
                <tr>
                    <td><span class="badge bg-light text-dark">#${c.detalleId}</span></td>
                    <td><strong>${c.descripcionCorta || 'Sin descripción'}</strong></td>
                    <td>${formatDate(c.fechaInicioReal || c.fechaInicio)}</td>
                    <td>${formatDate(c.fechaFinal)}</td>
                    <td class="text-end">
                        <strong class="text-success">RD$ ${(c.montoAcordado || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong>
                    </td>
                    <td class="text-center">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: ${c.porcentajeAvance || 0}%">
                                ${c.porcentajeAvance || 0}%
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${c.detalleId})" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="completarTrabajo(${c.detalleId})" title="Marcar completado">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelarContratacion(${c.detalleId})" title="Cancelar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderCompletadas() {
            const tbody = document.getElementById('tbodyCompletadas');
            
            if (!allCompletadas.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-check-circle fa-2x text-muted mb-3 d-block"></i>
                            <span class="text-muted">No hay trabajos completados</span>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allCompletadas.map(c => `
                <tr>
                    <td><span class="badge bg-light text-dark">#${c.detalleId}</span></td>
                    <td><strong>${c.descripcionCorta || 'Sin descripción'}</strong></td>
                    <td>
                        <small>${formatDate(c.fechaInicio)} - ${formatDate(c.fechaFinalizacionReal || c.fechaFinal)}</small>
                    </td>
                    <td class="text-end">
                        <strong class="text-success">RD$ ${(c.montoAcordado || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong>
                    </td>
                    <td class="text-center">
                        ${c.calificado 
                            ? '<span class="badge bg-success"><i class="fas fa-star me-1"></i>Calificado</span>'
                            : '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pendiente</span>'}
                    </td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${c.detalleId})" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${!c.calificado ? `
                            <a href="@Url.Action("Calificaciones", "Empleador")?id=${c.detalleId}" class="btn btn-sm btn-outline-warning" title="Calificar">
                                <i class="fas fa-star"></i>
                            </a>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderCanceladas() {
            const tbody = document.getElementById('tbodyCanceladas');
            
            if (!allCanceladas.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <i class="fas fa-times-circle fa-2x text-muted mb-3 d-block"></i>
                            <span class="text-muted">No hay contrataciones canceladas</span>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allCanceladas.map(c => `
                <tr>
                    <td><span class="badge bg-light text-dark">#${c.detalleId}</span></td>
                    <td><strong>${c.descripcionCorta || 'Sin descripción'}</strong></td>
                    <td>${formatDate(c.fechaFinalizacionReal || c.fechaFinal)}</td>
                    <td class="text-end text-muted">
                        <s>RD$ ${(c.montoAcordado || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</s>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${c.detalleId})" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // ============================================
        // HELPERS
        // ============================================
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                return new Date(dateStr).toLocaleDateString('es-DO');
            } catch {
                return dateStr;
            }
        }
        
        function getStatusName(estatus) {
            const estados = {
                1: 'Pendiente',
                2: 'Aceptada',
                3: 'En Progreso',
                4: 'Completada',
                5: 'Cancelada',
                6: 'Rechazada'
            };
            return estados[estatus] || 'Desconocido';
        }
        
        function getStatusBadge(estatus) {
            const badges = {
                1: 'warning',
                2: 'info',
                3: 'primary',
                4: 'success',
                5: 'danger',
                6: 'secondary'
            };
            return badges[estatus] || 'secondary';
        }
        
        // ============================================
        // FORMULARIO NUEVA CONTRATACIÓN
        // ============================================
        function initFormEvents() {
            // Character counters
            document.getElementById('descripcionCorta').addEventListener('input', function(e) {
                document.getElementById('descripcionCortaCount').textContent = e.target.value.length;
            });
            
            document.getElementById('descripcionAmpliada').addEventListener('input', function(e) {
                document.getElementById('descripcionAmpliadaCount').textContent = e.target.value.length;
            });
            
            // Monto formatting
            document.getElementById('montoAcordado').addEventListener('blur', function(e) {
                const value = parseFloat(e.target.value.replace(/,/g, ''));
                if (!isNaN(value)) {
                    e.target.value = value.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
            });
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = today;
            document.getElementById('fechaInicio').min = today;
            
            // Guardar contratación
            document.getElementById('btnGuardarContratacion').addEventListener('click', crearContratacion);
            
            // Reset form on modal close
            document.getElementById('modalNuevaContratacion').addEventListener('hidden.bs.modal', resetForm);
            
            // Search handlers
            document.getElementById('searchPendientes').addEventListener('input', filterPendientes);
            document.getElementById('searchActivas').addEventListener('input', filterActivas);
            document.getElementById('searchCompletadas').addEventListener('input', filterCompletadas);
        }
        
        async function crearContratacion() {
            const token = getAuthToken();
            if (!token) {
                Swal.fire('Error', 'Debe iniciar sesión', 'error');
                return;
            }
            
            // Validar términos
            if (!document.getElementById('chkTerminos').checked) {
                Swal.fire('Error', 'Debe aceptar los términos y condiciones', 'error');
                return;
            }
            
            // Validar campos
            const descripcionCorta = document.getElementById('descripcionCorta').value.trim();
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const montoStr = document.getElementById('montoAcordado').value.replace(/,/g, '');
            const monto = parseFloat(montoStr);
            
            if (!descripcionCorta || !fechaInicio || !fechaFin || isNaN(monto) || monto <= 0) {
                Swal.fire('Error', 'Complete todos los campos requeridos correctamente', 'error');
                return;
            }
            
            if (new Date(fechaFin) < new Date(fechaInicio)) {
                Swal.fire('Error', 'La fecha de fin debe ser posterior a la fecha de inicio', 'error');
                return;
            }
            
            const command = {
                descripcionCorta: descripcionCorta,
                descripcionAmpliada: document.getElementById('descripcionAmpliada').value.trim() || null,
                fechaInicio: fechaInicio,
                fechaFinal: fechaFin,
                montoAcordado: monto,
                esquemaPagos: document.getElementById('esquemaPagos').value || null,
                notas: document.getElementById('notas').value.trim() || null
            };
            
            // Confirmar
            const confirm = await Swal.fire({
                title: '¿Crear contratación?',
                html: `
                    <p><strong>${descripcionCorta}</strong></p>
                    <p>Monto: <strong>RD$ ${monto.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></p>
                    <p>Período: ${new Date(fechaInicio).toLocaleDateString('es-DO')} - ${new Date(fechaFin).toLocaleDateString('es-DO')}</p>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-check me-1"></i>Sí, crear',
                cancelButtonText: 'Cancelar'
            });
            
            if (!confirm.isConfirmed) return;
            
            try {
                document.getElementById('btnGuardarContratacion').disabled = true;
                document.getElementById('btnGuardarContratacion').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creando...';
                
                const response = await fetch(`${API_BASE_URL}/contrataciones`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(command)
                });
                
                if (response.ok) {
                    const detalleId = await response.json();
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalNuevaContratacion')).hide();
                    
                    // Mostrar éxito
                    await Swal.fire({
                        title: '¡Contratación Creada!',
                        html: `<p>ID de contratación: <strong>#${detalleId}</strong></p>`,
                        icon: 'success',
                        confirmButtonText: 'Aceptar'
                    });
                    
                    // Recargar datos
                    loadContrataciones();
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'No se pudo crear la contratación', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'Error de conexión', 'error');
            } finally {
                document.getElementById('btnGuardarContratacion').disabled = false;
                document.getElementById('btnGuardarContratacion').innerHTML = '<i class="fas fa-save me-1"></i>Crear Contratación';
            }
        }
        
        function resetForm() {
            document.getElementById('formNuevaContratacion').reset();
            document.getElementById('descripcionCortaCount').textContent = '0';
            document.getElementById('descripcionAmpliadaCount').textContent = '0';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaInicio').value = today;
            hideAlert('contratacionAlert');
        }
        
        function showAlert(id, message, type = 'danger') {
            const alert = document.getElementById(id);
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('d-none');
        }
        
        function hideAlert(id) {
            document.getElementById(id).classList.add('d-none');
        }
        
        // ============================================
        // ACCIONES
        // ============================================
        async function verDetalle(detalleId) {
            const token = getAuthToken();
            if (!token) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/contrataciones/${detalleId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('detalleId').textContent = detalleId;
                    document.getElementById('detalleBody').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Descripción:</strong><br>${data.descripcionCorta || '-'}</p>
                                <p><strong>Detalle:</strong><br>${data.descripcionAmpliada || '-'}</p>
                                <p><strong>Estado:</strong> <span class="badge bg-${getStatusBadge(data.estatus)}">${data.nombreEstado || getStatusName(data.estatus)}</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Fecha Inicio:</strong> ${formatDate(data.fechaInicio)}</p>
                                <p><strong>Fecha Fin:</strong> ${formatDate(data.fechaFinal)}</p>
                                <p><strong>Monto:</strong> <span class="text-success fw-bold">RD$ ${(data.montoAcordado || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></p>
                                ${data.esquemaPagos ? `<p><strong>Esquema Pagos:</strong> ${data.esquemaPagos}</p>` : ''}
                            </div>
                        </div>
                        ${data.notas ? `<hr><p><strong>Notas:</strong> ${data.notas}</p>` : ''}
                    `;
                    
                    new bootstrap.Modal(document.getElementById('modalDetalle')).show();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        async function iniciarTrabajo(detalleId) {
            const confirm = await Swal.fire({
                title: '¿Iniciar trabajo?',
                text: 'Esto marcará la contratación como "En Progreso"',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                confirmButtonText: '<i class="fas fa-play me-1"></i>Iniciar',
                cancelButtonText: 'Cancelar'
            });
            
            if (!confirm.isConfirmed) return;
            
            const token = getAuthToken();
            try {
                const response = await fetch(`${API_BASE_URL}/contrataciones/${detalleId}/start`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    Swal.fire('¡Iniciado!', 'El trabajo ha sido iniciado', 'success');
                    loadContrataciones();
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'No se pudo iniciar', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Error de conexión', 'error');
            }
        }
        
        async function completarTrabajo(detalleId) {
            const confirm = await Swal.fire({
                title: '¿Marcar como completado?',
                text: 'Esto finalizará el trabajo y podrás calificarlo',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                confirmButtonText: '<i class="fas fa-check me-1"></i>Completar',
                cancelButtonText: 'Cancelar'
            });
            
            if (!confirm.isConfirmed) return;
            
            const token = getAuthToken();
            try {
                const response = await fetch(`${API_BASE_URL}/contrataciones/${detalleId}/complete`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    await Swal.fire('¡Completado!', 'El trabajo ha sido marcado como completado', 'success');
                    loadContrataciones();
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'No se pudo completar', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Error de conexión', 'error');
            }
        }
        
        async function cancelarContratacion(detalleId) {
            const result = await Swal.fire({
                title: '¿Cancelar contratación?',
                text: 'Esta acción no se puede deshacer',
                input: 'text',
                inputLabel: 'Motivo de cancelación',
                inputPlaceholder: 'Ingrese el motivo...',
                inputAttributes: { maxlength: 200 },
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: '<i class="fas fa-times me-1"></i>Cancelar contratación',
                cancelButtonText: 'Volver',
                inputValidator: (value) => {
                    if (!value) return 'Debe ingresar un motivo';
                }
            });
            
            if (!result.isConfirmed) return;
            
            const token = getAuthToken();
            try {
                const response = await fetch(`${API_BASE_URL}/contrataciones/${detalleId}/cancel`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ detalleId: detalleId, motivo: result.value })
                });
                
                if (response.ok) {
                    Swal.fire('Cancelada', 'La contratación ha sido cancelada', 'success');
                    loadContrataciones();
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.error || 'No se pudo cancelar', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Error de conexión', 'error');
            }
        }
        
        // ============================================
        // BÚSQUEDA
        // ============================================
        function filterPendientes() {
            const term = document.getElementById('searchPendientes').value.toLowerCase().trim();
            if (!term) {
                renderPendientes();
                return;
            }
            
            const filtered = allPendientes.filter(c => 
                (c.descripcionCorta || '').toLowerCase().includes(term) ||
                (c.nombreEstado || '').toLowerCase().includes(term)
            );
            
            renderFilteredTable('tbodyPendientes', filtered, 7, renderPendientesRow);
        }
        
        function filterActivas() {
            const term = document.getElementById('searchActivas').value.toLowerCase().trim();
            if (!term) {
                renderActivas();
                return;
            }
            
            const filtered = allActivas.filter(c => 
                (c.descripcionCorta || '').toLowerCase().includes(term)
            );
            
            renderFilteredTable('tbodyActivas', filtered, 7, renderActivasRow);
        }
        
        function filterCompletadas() {
            const term = document.getElementById('searchCompletadas').value.toLowerCase().trim();
            if (!term) {
                renderCompletadas();
                return;
            }
            
            const filtered = allCompletadas.filter(c => 
                (c.descripcionCorta || '').toLowerCase().includes(term)
            );
            
            renderFilteredTable('tbodyCompletadas', filtered, 6, renderCompletadasRow);
        }
        
        function renderFilteredTable(tbodyId, data, cols, rowFn) {
            const tbody = document.getElementById(tbodyId);
            if (!data.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${cols}" class="text-center py-5">
                            <i class="fas fa-search fa-2x text-muted mb-3 d-block"></i>
                            <span class="text-muted">No se encontraron resultados</span>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(c => rowFn(c)).join('');
        }
        
        function renderPendientesRow(c) {
            return `
                <tr>
                    <td><span class="badge bg-light text-dark">#${c.detalleId}</span></td>
                    <td><strong>${c.descripcionCorta || 'Sin descripción'}</strong></td>
                    <td>${formatDate(c.fechaInicio)}</td>
                    <td>${formatDate(c.fechaFinal)}</td>
                    <td class="text-end"><strong class="text-success">RD$ ${(c.montoAcordado || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                    <td class="text-center"><span class="badge bg-${getStatusBadge(c.estatus)}">${c.nombreEstado || getStatusName(c.estatus)}</span></td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${c.detalleId})"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-success" onclick="iniciarTrabajo(${c.detalleId})"><i class="fas fa-play"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelarContratacion(${c.detalleId})"><i class="fas fa-times"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function renderActivasRow(c) {
            return `
                <tr>
                    <td><span class="badge bg-light text-dark">#${c.detalleId}</span></td>
                    <td><strong>${c.descripcionCorta || 'Sin descripción'}</strong></td>
                    <td>${formatDate(c.fechaInicioReal || c.fechaInicio)}</td>
                    <td>${formatDate(c.fechaFinal)}</td>
                    <td class="text-end"><strong class="text-success">RD$ ${(c.montoAcordado || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                    <td class="text-center"><div class="progress" style="height: 20px;"><div class="progress-bar bg-info" style="width: ${c.porcentajeAvance || 0}%">${c.porcentajeAvance || 0}%</div></div></td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${c.detalleId})"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-success" onclick="completarTrabajo(${c.detalleId})"><i class="fas fa-check"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelarContratacion(${c.detalleId})"><i class="fas fa-times"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function renderCompletadasRow(c) {
            return `
                <tr>
                    <td><span class="badge bg-light text-dark">#${c.detalleId}</span></td>
                    <td><strong>${c.descripcionCorta || 'Sin descripción'}</strong></td>
                    <td><small>${formatDate(c.fechaInicio)} - ${formatDate(c.fechaFinalizacionReal || c.fechaFinal)}</small></td>
                    <td class="text-end"><strong class="text-success">RD$ ${(c.montoAcordado || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                    <td class="text-center">${c.calificado ? '<span class="badge bg-success"><i class="fas fa-star me-1"></i>Calificado</span>' : '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pendiente</span>'}</td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${c.detalleId})"><i class="fas fa-eye"></i></button>
                            ${!c.calificado ? `<a href="@Url.Action("Calificaciones", "Empleador")?id=${c.detalleId}" class="btn btn-sm btn-outline-warning"><i class="fas fa-star"></i></a>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }
    </script>
}
