@model dynamic
@{
    Layout = "~/Views/Shared/_LayoutEmpleador.cshtml";
    ViewData["Title"] = "Checkout - Completar Orden";
}

<style>
    .card {
        box-shadow: 0 20px 27px 0 rgb(0 0 0 / 5%);
    }

    .card {
        position: relative;
        display: flex;
        flex-direction: column;
        min-width: 0;
        word-wrap: break-word;
        background-color: #fff;
        background-clip: border-box;
        border: 0 solid rgba(0,0,0,.125);
        border-radius: 1rem;
    }

    .card-body {
        -webkit-box-flex: 1;
        -ms-flex: 1 1 auto;
        flex: 1 1 auto;
        padding: 1.5rem 1.5rem;
    }
</style>

<div class="container" style="background-color:white; border-radius:10px;">
    <br />
    <h1 class="h3 mb-5">Complete su Orden</h1>
    
    <form id="formCheckout">
        <div class="row">
            <!-- Left - Payment Form -->
            <div class="col-lg-9">
                <div class="accordion" id="accordionPayment">
                    <!-- Credit card -->
                    <img src="~/images/Cardnet-Web.png" width="200" alt="Cardnet" />
                    <div id="collapseCC" class="accordion-collapse collapse show" style="margin-top: 20px;">

                        <div class="mb-3">
                            <label class="form-label">Número de Tarjeta</label>
                            <input type="text" class="form-control" id="cardNumber" name="CardNumber" 
                                   placeholder="0000 0000 0000 0000" maxlength="19" required />
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label">Nombre en la Tarjeta</label>
                                    <input type="text" class="form-control" id="cardName" name="CardName" 
                                           placeholder="Como aparece en la tarjeta" required />
                                </div>
                            </div>

                            <div class="col-lg-3">
                                <div class="mb-3">
                                    <label class="form-label">Fecha de Expiración (MM/AA)</label>
                                    <input type="text" class="form-control" id="expiryDate" name="ExpiryDate" 
                                           placeholder="MM/AA" maxlength="5" required />
                                </div>
                            </div>

                            <div class="col-lg-3">
                                <div class="mb-3">
                                    <label class="form-label">CVV</label>
                                    <input type="password" class="form-control" id="cvvNumber" name="CVV" 
                                           placeholder="***" maxlength="4" required />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right - Order Summary -->
            <div class="col-lg-3">
                <div class="card position-sticky top-0">
                    <div class="p-3 bg-light bg-opacity-10">
                        <h6 class="card-title mb-3">Resumen de Orden</h6>

                        <div class="d-flex justify-content-between mb-1 small">
                            <label style="font-size:large" class="col-lg-12">Nombre de Plan</label>
                        </div>

                        <div>
                            <label style="font-size:medium" class="col-lg-12" id="lbPlanName">@ViewBag.PlanNombre</label>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between mb-1 small">
                            <span>TOTAL A PAGAR</span> 
                            <strong id="amount" class="text-dark">@ViewBag.Total</strong>
                        </div>

                        <div class="form-check small mb-2">
                            <input type="checkbox" class="form-check-input" id="chkTerminosMiGente" name="AceptaTerminos" required />
                            <label class="form-check-label" for="chkTerminosMiGente">
                                Acepto los 
                                <a href="javascript:void(0)" id="enlaceTerminos1">Términos y Condiciones</a>
                            </label>
                        </div>

                        <div class="form-check small mb-3" id="divAutorizacionEmpleadores">
                            <input type="checkbox" class="form-check-input" id="chkAutorizacion" name="AceptaAutorizacion" required />
                            <label class="form-check-label" for="chkAutorizacion">
                                Acepto los 
                                <a href="javascript:void(0)" id="enlaceTerminos2">Términos de inscripción de Empleadores</a>
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block w-100" id="btnPay">
                            <i class="fa fa-lock"></i> Adquirir Plan
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden fields -->
        <input type="hidden" id="planId" name="PlanId" value="@ViewBag.PlanId" />
    </form>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            // Formatear número de tarjeta con espacios
            $('#cardNumber').on('input', function () {
                var value = $(this).val().replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                var matches = value.match(/\d{4,16}/g);
                var match = matches && matches[0] || '';
                var parts = [];

                for (var i = 0, len = match.length; i < len; i += 4) {
                    parts.push(match.substring(i, i + 4));
                }

                if (parts.length) {
                    $(this).val(parts.join(' '));
                } else {
                    $(this).val(value);
                }
            });

            // Formatear fecha de expiración
            $('#expiryDate').on('input', function () {
                var value = $(this).val().replace(/\D/g, '');
                if (value.length >= 2) {
                    $(this).val(value.substring(0, 2) + '/' + value.substring(2, 4));
                } else {
                    $(this).val(value);
                }
            });

            // Abrir términos en ventana emergente
            $('#enlaceTerminos1').click(function (e) {
                e.preventDefault();
                var opcionesVentana = "width=800, height=600, resizable=yes, scrollbars=yes";
                window.open('/templates/legal/TerminosMiGente.html', 'Términos y Condiciones', opcionesVentana);
            });

            $('#enlaceTerminos2').click(function (e) {
                e.preventDefault();
                var opcionesVentana = "width=800, height=600, resizable=yes, scrollbars=yes";
                window.open('/templates/legal/AutorizacionEmpleadores.html', 'Términos de inscripción', opcionesVentana);
            });
        });

        // Procesar pago
        $('#formCheckout').submit(function (e) {
            e.preventDefault();

            // Validar términos
            if (!$('#chkTerminosMiGente').is(':checked') || !$('#chkAutorizacion').is(':checked')) {
                mostrarAlertaTerminos();
                return;
            }

            // Mostrar loading
            Swal.fire({
                title: 'Procesando pago...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Preparar datos
            var formData = {
                CardNumber: $('#cardNumber').val().replace(/\s/g, ''),
                CardName: $('#cardName').val(),
                ExpiryDate: $('#expiryDate').val(),
                CVV: $('#cvvNumber').val(),
                PlanId: $('#planId').val()
            };

            // TODO: Enviar a API
            // $.ajax({
            //     url: '/api/pagos/procesar',
            //     method: 'POST',
            //     data: JSON.stringify(formData),
            //     contentType: 'application/json',
            //     success: function(response) {
            //         mostrarAlertaSuscripcionExitosa();
            //     },
            //     error: function(error) {
            //         mostrarAlertaProblemaPago();
            //     }
            // });

            // Simulación temporal
            setTimeout(function () {
                mostrarAlertaSuscripcionExitosa();
            }, 2000);
        });

        // Función para mostrar alerta de suscripción exitosa
        function mostrarAlertaSuscripcionExitosa() {
            Swal.fire({
                icon: 'success',
                title: '¡Suscripción completada!',
                text: 'Tu suscripción se ha completado correctamente.',
                confirmButtonText: 'OK',
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/Empleador/MiPerfil';
                }
            });
        }

        // Función para mostrar alerta de problema al procesar el pago
        function mostrarAlertaProblemaPago() {
            Swal.fire({
                icon: 'error',
                title: '¡Error al procesar el pago!',
                text: 'Ha ocurrido un problema al procesar tu pago. Por favor, inténtalo de nuevo.',
            });
        }

        function mostrarAlertaTerminos() {
            Swal.fire({
                icon: 'error',
                title: '¡No Puede Continuar con El Registro!',
                text: 'Debe Aceptar todos los Términos y Condiciones.',
            });
        }
    </script>
}
