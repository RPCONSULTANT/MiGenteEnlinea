@*
    Calificación de Perfiles - Empleador
    EXACTO al: FRONT_Publicado/Empleador/CalificacionDePerfiles.aspx
    Tema: Argon Dashboard 2.0
*@
@{
    ViewData["Title"] = "Calificación de Perfiles";
    Layout = "_LayoutEmpleador";
}

@section Styles {
    <style>
        .star {
            font-size: 24px;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star.filled,
        .star.hover {
            color: #ffc107;
        }
        .star-display {
            font-size: 18px;
        }
    </style>
}

<!-- Título de la sección -->
<div class="container mt-1">
    <div class="section-title justify-content-center" style="text-align: center;">
        <h2 class="text-white">Calificación de Perfiles</h2>
    </div>
    
    <!-- Cards de acciones -->
    <div class="row">
        <!-- Card Calificar Perfil -->
        <div class="col-md-6 mt-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Calificar Perfil</h5>
                    <i class="fas fa-star fa-5x text-warning mb-3"></i>
                    <p class="card-text">Califica perfiles y se colabora al crecimiento de esta gran comunidad.</p>
                    <button type="button" data-bs-toggle="modal" data-bs-target="#modalCalificar" class="btn btn-primary">Calificar</button>
                </div>
            </div>
        </div>
        
        <!-- Card Consultar Perfiles -->
        <div class="col-md-6 mt-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Consultar Perfiles</h5>
                    <i class="fas fa-search fa-5x text-primary mb-3"></i>
                    <p class="card-text">Utiliza el directorio para buscar y consultar perfiles.</p>
                    <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalConsultarPerfil">Consultar</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sección Mis Calificaciones -->
<div class="container mt-6 align-content-center" style="text-align: center">
    <h3>Mis calificaciones</h3>
    
    <div class="table-responsive">
        <div class="card">
            <table class="table table-bordered table-sm" id="gridCalificaciones">
                <thead>
                    <tr>
                        <th scope="col">Fecha</th>
                        <th scope="col">Identificación</th>
                        <th scope="col">Nombre</th>
                        <th scope="col">Puntualidad</th>
                        <th scope="col">Conocimientos</th>
                        <th scope="col">Cumplimiento</th>
                        <th scope="col">Recomendación</th>
                    </tr>
                </thead>
                <tbody id="tbodyCalificaciones">
                    <tr class="empty-data-row">
                        <td colspan="7">
                            <div>No data to display</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Calificar Perfil -->
<div class="modal fade" id="modalCalificar" tabindex="-1" aria-labelledby="modalCalificarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-white" id="modalCalificarLabel">Calificar Perfil</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Selector de perfil -->
                <div class="mb-3">
                    <label for="ddlPerfil" class="form-label">Seleccione Perfil para Calificar</label>
                    <select id="ddlPerfil" class="form-select" onchange="onPerfilSeleccionado()">
                        <option value="">-- Seleccione un perfil --</option>
                    </select>
                </div>
                
                <!-- RNC/Cédula -->
                <div class="mb-3">
                    <label for="calif_identificacion" class="form-label">RNC/Cédula</label>
                    <input type="text" class="form-control" id="calif_identificacion" disabled />
                </div>
                
                <!-- Nombre -->
                <div class="mb-3">
                    <label for="calif_nombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="calif_nombre" disabled />
                </div>
                
                <!-- Rating Puntualidad -->
                <div class="mb-3">
                    <label class="form-label">¿Cuántas estrellas le das a su puntualidad?</label>
                    <div class="rating-input" id="ratingPuntualidad">
                        <i class="fas fa-star star" data-value="1"></i>
                        <i class="fas fa-star star" data-value="2"></i>
                        <i class="fas fa-star star" data-value="3"></i>
                        <i class="fas fa-star star" data-value="4"></i>
                        <i class="fas fa-star star" data-value="5"></i>
                    </div>
                    <input type="hidden" id="valorPuntualidad" value="0">
                </div>
                
                <!-- Rating Cumplimiento -->
                <div class="mb-3">
                    <label class="form-label">¿Qué te pareció el Servicio Recibido?</label>
                    <div class="rating-input" id="ratingCumplimiento">
                        <i class="fas fa-star star" data-value="1"></i>
                        <i class="fas fa-star star" data-value="2"></i>
                        <i class="fas fa-star star" data-value="3"></i>
                        <i class="fas fa-star star" data-value="4"></i>
                        <i class="fas fa-star star" data-value="5"></i>
                    </div>
                    <input type="hidden" id="valorCumplimiento" value="0">
                </div>
                
                <!-- Rating Conocimientos -->
                <div class="mb-3">
                    <label class="form-label">¿Cómo calificas sus conocimientos profesionales?</label>
                    <div class="rating-input" id="ratingConocimientos">
                        <i class="fas fa-star star" data-value="1"></i>
                        <i class="fas fa-star star" data-value="2"></i>
                        <i class="fas fa-star star" data-value="3"></i>
                        <i class="fas fa-star star" data-value="4"></i>
                        <i class="fas fa-star star" data-value="5"></i>
                    </div>
                    <input type="hidden" id="valorConocimientos" value="0">
                </div>
                
                <!-- Rating Recomendación -->
                <div class="mb-3">
                    <label class="form-label">¿Qué tanto lo recomendarías?</label>
                    <div class="rating-input" id="ratingRecomendacion">
                        <i class="fas fa-star star" data-value="1"></i>
                        <i class="fas fa-star star" data-value="2"></i>
                        <i class="fas fa-star star" data-value="3"></i>
                        <i class="fas fa-star star" data-value="4"></i>
                        <i class="fas fa-star star" data-value="5"></i>
                    </div>
                    <input type="hidden" id="valorRecomendacion" value="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnRealizarCalificacion" disabled onclick="calificarPerfil()">Realizar Calificacion</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Consultar Perfil -->
<div class="modal fade" id="modalConsultarPerfil" tabindex="-1" aria-labelledby="modalConsultarPerfilLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-white" id="modalConsultarPerfilLabel">Consultar Perfil</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="txtConsultarId" class="form-label">Identificación</label>
                    <input type="text" class="form-control" id="txtConsultarId" placeholder="RNC/Cédula" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="consultarPerfil()">Consultar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Perfil Encontrado -->
<div class="modal fade" id="modalPerfilEncontrado" tabindex="-1" aria-labelledby="modalPerfilEncontradoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title text-white" id="modalPerfilEncontradoLabel">Perfil Encontrado</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-user fa-5x text-secondary mb-3"></i>
                    <p class="mb-1"><strong>Tipo:</strong> <span id="perfil_tipo">Contratista</span></p>
                    <p class="mb-1"><strong>Identificación:</strong> <span id="perfil_identificacion">-</span></p>
                    <p class="mb-3"><strong>Nombre:</strong> <span id="perfil_nombre">-</span></p>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-12">
                        <div class="mb-2">
                            <span class="me-2"><strong>Puntualidad:</strong></span>
                            <span class="star-display" id="display_puntualidad"></span>
                        </div>
                        <div class="mb-2">
                            <span class="me-2"><strong>Cumplimiento:</strong></span>
                            <span class="star-display" id="display_cumplimiento"></span>
                        </div>
                        <div class="mb-2">
                            <span class="me-2"><strong>Conocimientos:</strong></span>
                            <span class="star-display" id="display_conocimientos"></span>
                        </div>
                        <div class="mb-2">
                            <span class="me-2"><strong>Recomendación:</strong></span>
                            <span class="star-display" id="display_recomendacion"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Variables globales
        var perfilesCalificables = [];
        var perfilSeleccionado = null;
        
        $(document).ready(function() {
            // Cargar historial de calificaciones
            cargarMisCalificaciones();
            
            // Cargar perfiles disponibles para calificar
            cargarPerfilesCalificables();
            
            // Configurar sistema de estrellas
            configurarRatings();
        });
        
        function configurarRatings() {
            // Click en estrella
            $('.rating-input .star').on('click', function() {
                var container = $(this).parent();
                var value = $(this).data('value');
                var inputId = container.attr('id').replace('rating', 'valor');
                
                container.find('.star').removeClass('filled');
                container.find('.star').each(function() {
                    if ($(this).data('value') <= value) {
                        $(this).addClass('filled');
                    }
                });
                
                $('#' + inputId).val(value);
                verificarFormulario();
            });
            
            // Hover en estrellas
            $('.rating-input .star').on('mouseenter', function() {
                var container = $(this).parent();
                var value = $(this).data('value');
                
                container.find('.star').removeClass('hover');
                container.find('.star').each(function() {
                    if ($(this).data('value') <= value) {
                        $(this).addClass('hover');
                    }
                });
            });
            
            $('.rating-input').on('mouseleave', function() {
                $(this).find('.star').removeClass('hover');
            });
        }
        
        function cargarMisCalificaciones() {
            // ✅ Cargar mis calificaciones históricas
            const userId = getUserIdFromToken();
            if (!userId) {
                console.warn('No userId available for loading calificaciones');
                return;
            }
            
            authenticatedFetch('/calificaciones/por-empleador/' + userId)
                .then(response => response.json())
                .then(data => {
                    renderizarTablaCalificaciones(data);
                })
                .catch(error => {
                    console.error('Error cargando calificaciones:', error);
                    // No mostrar error si no hay calificaciones aún
                });
        }
        
        function renderizarTablaCalificaciones(calificaciones) {
            var tbody = $('#tbodyCalificaciones');
            tbody.empty();
            
            if (!calificaciones || calificaciones.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-inbox fa-2x text-muted mb-3 d-block"></i>
                            <span class="text-muted">No hay calificaciones registradas</span>
                        </td>
                    </tr>
                `);
                return;
            }
            
            calificaciones.forEach(function(c) {
                var row = $(`
                    <tr>
                        <td>${c.contratistaIdentificacion || 'N/A'}</td>
                        <td>${c.contratistaCompleteName || 'Desconocido'}</td>
                        <td>${convertirANumeroEstrellas(c.puntualidad)}</td>
                        <td>${convertirANumeroEstrellas(c.cumplimiento)}</td>
                        <td>${convertirANumeroEstrellas(c.conocimientos)}</td>
                        <td>${convertirANumeroEstrellas(c.recomendacion)}</td>
                        <td>${new Date(c.fechaCalificacion).toLocaleDateString('es-DO')}</td>
                    </tr>
                `);
                tbody.append(row);
            });
        }
        
        function cargarPerfilesCalificables() {
            // ✅ Cargar contrataciones completadas sin calificar
            authenticatedFetch('/contrataciones?soloNoCalificadas=true&pageSize=100')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        // Mapear contrataciones a formato de perfiles
                        perfilesCalificables = data.map(function(c) {
                            return {
                                id: c.detalleId,
                                identificacion: c.contratistaIdentificacion || 'SIN_ID',
                                nombre: c.contratistaCompleteName || 'Contratista Desconocido',
                                monto: c.montoAcordado,
                                descripcion: c.descripcionCorta,
                                fotoUrl: c.contratistaFotoUrl,
                                fechaInicio: c.fechaInicio,
                                fechaFinalizacion: c.fechaFinalizacionReal || c.fechaFinal
                            };
                        });
                        
                        Swal.fire({
                            title: '✅ Éxito',
                            text: 'Se cargaron ' + perfilesCalificables.length + ' perfil(es) para calificar',
                            icon: 'success',
                            toast: true,
                            position: 'top-end',
                            timer: 2000
                        });
                        
                        llenarDropdownPerfiles();
                    } else {
                        Swal.fire({
                            title: '⚠️ Sin resultados',
                            text: 'No hay trabajos completados pendientes de calificar',
                            icon: 'info',
                            toast: true,
                            position: 'top-end',
                            timer: 3000
                        });
                    }
                })
                .catch(error => {
                    console.error('Error cargando perfiles calificables:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'No se pudieron cargar los perfiles disponibles para calificar.',
                        icon: 'error'
                    });
                });
        }
        
        function llenarDropdownPerfiles() {
            var $ddl = $('#ddlPerfil');
            $ddl.empty();
            $ddl.append('<option value="">-- Seleccione un perfil --</option>');
            
            perfilesCalificables.forEach(function(p) {
                var displayText = p.nombre + ' (' + p.descripcion + ')';
                $ddl.append(`
                    <option value="${p.id}" 
                            data-identificacion="${p.identificacion}" 
                            data-nombre="${p.nombre}"
                            data-foto="${p.fotoUrl || '/images/circular1.png'}"
                            data-monto="${p.monto}"
                            data-fechas="${p.fechaInicio} a ${p.fechaFinalizacion}">
                        ${displayText}
                    </option>
                `);
            });
        }
        
        function onPerfilSeleccionado() {
            var $selected = $('#ddlPerfil option:selected');
            var id = $selected.val();
            
            if (id) {
                $('#calif_identificacion').val($selected.data('identificacion'));
                $('#calif_nombre').val($selected.data('nombre'));
                
                // ✅ Mostrar foto del contratista
                var fotoUrl = $selected.data('foto') || '/images/circular1.png';
                $('#fotoContratista').attr('src', fotoUrl)
                    .on('error', function() {
                        $(this).attr('src', '/images/circular1.png');
                    });
                
                perfilSeleccionado = id;
            } else {
                $('#calif_identificacion').val('');
                $('#calif_nombre').val('');
                $('#fotoContratista').attr('src', '/images/circular1.png');
                perfilSeleccionado = null;
            }
            verificarFormulario();
        }
        
        function verificarFormulario() {
            var puntualidad = parseInt($('#valorPuntualidad').val()) || 0;
            var cumplimiento = parseInt($('#valorCumplimiento').val()) || 0;
            var conocimientos = parseInt($('#valorConocimientos').val()) || 0;
            var recomendacion = parseInt($('#valorRecomendacion').val()) || 0;
            var perfilId = $('#ddlPerfil').val();
            
            if (perfilId && puntualidad > 0 && cumplimiento > 0 && conocimientos > 0 && recomendacion > 0) {
                $('#btnRealizarCalificacion').prop('disabled', false);
            } else {
                $('#btnRealizarCalificacion').prop('disabled', true);
            }
        }
        
        function calificarPerfil() {
            var identificacion = $('#calif_identificacion').val();
            
            if (!identificacion) {
                Swal.fire({
                    title: '⚠️ Error',
                    text: 'No se pudo obtener la identificación del contratista.',
                    icon: 'error'
                });
                return;
            }
            
            var datos = {
                empleadorUserId: getUserIdFromToken(), // Helper function to extract from JWT
                contratistaIdentificacion: identificacion,
                puntualidad: parseInt($('#valorPuntualidad').val()),
                cumplimiento: parseInt($('#valorCumplimiento').val()),
                conocimientos: parseInt($('#valorConocimientos').val()),
                recomendacion: parseInt($('#valorRecomendacion').val())
            };
            
            // ✅ Enviar calificación al API
            authenticatedFetch('/calificaciones/calificar-perfil', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
                .then(response => response.json())
                .then(response => {
                    onSuccess(response);
                })
                .catch(error => {
                    console.error('Error al calificar:', error);
                    var errorMsg = 'No se pudo guardar la calificación. Intente nuevamente.';
                    if (error.response && error.response.message) {
                        errorMsg = error.response.message;
                    }
                    Swal.fire({
                        title: '❌ Error',
                        text: errorMsg,
                        icon: 'error'
                    });
                });
        }
        
        // ✅ Helper: Extract userId from JWT token
        function getUserIdFromToken() {
            var token = localStorage.getItem('accessToken') || localStorage.getItem('token') || sessionStorage.getItem('token');
            if (!token) return null;
            
            try {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                var payload = JSON.parse(jsonPayload);
                return payload['nameid'] || payload['sub'] || payload['userId'];
            } catch (e) {
                console.error('Error decoding token:', e);
                return null;
            }
        }
        
        function onSuccess(response) {
            $('#modalCalificar').modal('hide');
            Swal.fire({
                title: '¡Éxito!',
                text: 'La calificación ha sido registrada correctamente.',
                icon: 'success',
                confirmButtonText: 'Aceptar'
            });
            
            limpiarFormularioCalificacion();
            cargarMisCalificaciones();
        }
        
        function onError(error) {
            Swal.fire({
                title: 'Error',
                text: 'No se pudo guardar la calificación. Intente nuevamente.',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
        }
        
        function limpiarFormularioCalificacion() {
            $('#ddlPerfil').val('');
            $('#calif_identificacion').val('');
            $('#calif_nombre').val('');
            $('.rating-input .star').removeClass('filled');
            $('[id^=valor]').val(0);
            $('#btnRealizarCalificacion').prop('disabled', true);
            perfilSeleccionado = null;
        }
        
        function consultarPerfil() {
            var identificacion = $('#txtConsultarId').val().trim();
            
            if (!identificacion) {
                Swal.fire({
                    title: 'Error',
                    text: 'Por favor ingrese una identificación.',
                    icon: 'warning',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }
            
            // TODO: Llamar API para buscar perfil
            // $.get('/api/contratistas/buscar/' + identificacion, function(data) {
            //     mostrarModalPerfil(data);
            // }).fail(function() {
            //     Swal.fire('Error', 'Perfil no encontrado.', 'error');
            // });
            
            // Simulación
            var perfilEncontrado = {
                tipo: 'Contratista',
                identificacion: identificacion,
                nombre: 'Juan Pérez García',
                puntualidad: 4,
                cumplimiento: 5,
                conocimientos: 4,
                recomendacion: 5
            };
            mostrarModalPerfil(perfilEncontrado);
        }
        
        function mostrarModalPerfil(perfil) {
            $('#modalConsultarPerfil').modal('hide');
            
            $('#perfil_tipo').text(perfil.tipo);
            $('#perfil_identificacion').text(perfil.identificacion);
            $('#perfil_nombre').text(perfil.nombre);
            
            // Mostrar estrellas
            $('#display_puntualidad').html(convertirANumeroEstrellas(perfil.puntualidad));
            $('#display_cumplimiento').html(convertirANumeroEstrellas(perfil.cumplimiento));
            $('#display_conocimientos').html(convertirANumeroEstrellas(perfil.conocimientos));
            $('#display_recomendacion').html(convertirANumeroEstrellas(perfil.recomendacion));
            
            $('#modalPerfilEncontrado').modal('show');
        }
        
        function convertirANumeroEstrellas(valor) {
            var html = '';
            for (var i = 1; i <= 5; i++) {
                if (i <= valor) {
                    html += '<i class="fas fa-star text-warning"></i>';
                } else {
                    html += '<i class="far fa-star text-muted"></i>';
                }
            }
            return html;
        }
        
        function renderizarTablaCalificaciones(data) {
            var $tbody = $('#tbodyCalificaciones');
            $tbody.empty();
            
            if (!data || data.length === 0) {
                $tbody.append('<tr class="empty-data-row"><td colspan="7"><div>No data to display</div></td></tr>');
                return;
            }
            
            data.forEach(function(c) {
                var row = '<tr>';
                row += '<td>' + formatearFecha(c.fecha) + '</td>';
                row += '<td>' + c.identificacion + '</td>';
                row += '<td>' + c.nombre + '</td>';
                row += '<td>' + convertirANumeroEstrellas(c.puntualidad) + '</td>';
                row += '<td>' + convertirANumeroEstrellas(c.conocimientos) + '</td>';
                row += '<td>' + convertirANumeroEstrellas(c.cumplimiento) + '</td>';
                row += '<td>' + convertirANumeroEstrellas(c.recomendacion) + '</td>';
                row += '</tr>';
                $tbody.append(row);
            });
        }
        
        function formatearFecha(fecha) {
            if (!fecha) return '-';
            var d = new Date(fecha);
            return d.toLocaleDateString('es-DO');
        }
    </script>
}
