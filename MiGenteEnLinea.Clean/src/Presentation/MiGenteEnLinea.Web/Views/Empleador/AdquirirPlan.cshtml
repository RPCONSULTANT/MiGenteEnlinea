@{
    ViewData["Title"] = "Adquirir Plan";
    Layout = "_LayoutEmpleador";
}

<section id="pricing" class="pricing-content section-padding">
    <div class="container">
        <div class="section-title text-center">
            <h2 style="color:white">Nuestros Planes</h2>
            <p style="color:white">Para acceder y disfrutar de los beneficios que te ofrece Mi Gente en Línea, debes adquirir uno de nuestros planes</p>
        </div>
        <div class="row text-center" id="planesContainer">
            <!-- Plan 1 - Eres Mi Gente -->
            <div class="col-lg-4 col-sm-6 col-xs-12 mb-4">
                <div class="pricing_design">
                    <div class="single-pricing">
                        <div class="price-head">
                            <h4>Eres Mi Gente</h4>
                            <h2>RD$495.00</h2>
                            <span>/Anual</span>
                        </div>
                        <ul>
                            <li><b>1</b> Administrador</li>
                            <li><b>1</b> Registro de Empleado</li>
                            <li>Consultas Ilimitadas</li>
                            <li><b>12</b> Meses de Data Histórica</li>
                            <li style="color: #ccc;"><s>Usuarios de Consulta</s></li>
                            <li style="color: #ccc;"><s>Nómina TSS</s></li>
                        </ul>
                        <button class="price_btn" onclick="seleccionarPlan(1, 'Eres Mi Gente', 495)">
                            <i class="fa fa-shopping-cart me-2"></i>Adquirir
                        </button>
                    </div>
                </div>
            </div>
            <!-- Plan 2 - Somos Mi Gente -->
            <div class="col-lg-4 col-sm-6 col-xs-12 mb-4">
                <div class="pricing_design">
                    <div class="single-pricing" style="transform: scale(1.05);">
                        <span class="badge bg-warning text-dark mb-3" style="position: relative; top: -15px;">MÁS POPULAR</span>
                        <div class="price-head">
                            <h4>Somos Mi Gente</h4>
                            <h2>RD$1,695.00</h2>
                            <span>/Anual</span>
                        </div>
                        <ul>
                            <li><b>1</b> Administrador</li>
                            <li><b>1</b> Usuario de Consulta</li>
                            <li><b>5</b> Registros de Empleados</li>
                            <li>Consultas Ilimitadas</li>
                            <li><b>12</b> Meses de Data Histórica</li>
                            <li style="color: #ccc;"><s>Nómina TSS</s></li>
                        </ul>
                        <button class="price_btn" onclick="seleccionarPlan(2, 'Somos Mi Gente', 1695)">
                            <i class="fa fa-shopping-cart me-2"></i>Adquirir
                        </button>
                    </div>
                </div>
            </div>
            <!-- Plan 3 - Mi Gente Somos Todos -->
            <div class="col-lg-4 col-sm-6 col-xs-12 mb-4">
                <div class="pricing_design">
                    <div class="single-pricing">
                        <div class="price-head">
                            <h4>Mi Gente Somos Todos</h4>
                            <h2>RD$3,750.00</h2>
                            <span>/Anual</span>
                        </div>
                        <ul>
                            <li><b>1</b> Administrador</li>
                            <li><b>2</b> Usuarios de Consulta</li>
                            <li><b>15</b> Registros de Empleados</li>
                            <li>Consultas Ilimitadas</li>
                            <li><b>12</b> Meses de Data Histórica</li>
                            <li><b>Nómina</b> Pre-diseñada para TSS</li>
                        </ul>
                        <button class="price_btn" onclick="seleccionarPlan(3, 'Mi Gente Somos Todos', 3750)">
                            <i class="fa fa-shopping-cart me-2"></i>Adquirir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Comparación de Planes -->
<div class="container-fluid bg-white p-4" style="border-radius: 5px;">
    <div class="row mt-3">
        <div class="col-12">
            <h3 class="text-center mb-4">Comparación de Planes</h3>
            <div class="table-responsive">
                <table class="table table-bordered text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>Características</th>
                            <th style="background-color: #00176B; color: white;">Eres Mi Gente</th>
                            <th style="background-color: #00176B; color: white;">Somos Mi Gente</th>
                            <th style="background-color: #00176B; color: white;">Mi Gente Somos Todos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Precio Anual</strong></td>
                            <td>RD$495.00</td>
                            <td>RD$1,695.00</td>
                            <td>RD$3,750.00</td>
                        </tr>
                        <tr>
                            <td>Usuarios Administradores</td>
                            <td>1</td>
                            <td>1</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td>Usuarios de Consulta</td>
                            <td><i class="fa fa-times text-danger"></i></td>
                            <td>1</td>
                            <td>2</td>
                        </tr>
                        <tr>
                            <td>Cantidad de Empleados</td>
                            <td>1</td>
                            <td>Hasta 5</td>
                            <td>Hasta 15</td>
                        </tr>
                        <tr>
                            <td>Recibos de Pago</td>
                            <td><i class="fa fa-check text-success"></i></td>
                            <td><i class="fa fa-check text-success"></i></td>
                            <td><i class="fa fa-check text-success"></i></td>
                        </tr>
                        <tr>
                            <td>Contratos Laborales</td>
                            <td><i class="fa fa-check text-success"></i></td>
                            <td><i class="fa fa-check text-success"></i></td>
                            <td><i class="fa fa-check text-success"></i></td>
                        </tr>
                        <tr>
                            <td>Cálculo de Prestaciones</td>
                            <td><i class="fa fa-check text-success"></i></td>
                            <td><i class="fa fa-check text-success"></i></td>
                            <td><i class="fa fa-check text-success"></i></td>
                        </tr>
                        <tr>
                            <td>Nómina TSS</td>
                            <td><i class="fa fa-times text-danger"></i></td>
                            <td><i class="fa fa-times text-danger"></i></td>
                            <td><i class="fa fa-check text-success"></i></td>
                        </tr>
                        <tr>
                            <td>Data Histórica</td>
                            <td>12 Meses</td>
                            <td>12 Meses</td>
                            <td>12 Meses</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- FAQ Planes -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="text-center mb-4">Preguntas Frecuentes</h3>
            <div class="accordion" id="faqPlanes">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            ¿Puedo cambiar de plan en cualquier momento?
                        </button>
                    </h2>
                    <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqPlanes">
                        <div class="accordion-body">
                            Sí, puedes mejorar tu plan en cualquier momento. El sistema calculará automáticamente el prorrateo correspondiente.
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            ¿Qué métodos de pago aceptan?
                        </button>
                    </h2>
                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqPlanes">
                        <div class="accordion-body">
                            Aceptamos tarjetas de crédito y débito Visa y Mastercard a través de nuestra pasarela segura Cardnet.
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            ¿Los precios incluyen ITBIS?
                        </button>
                    </h2>
                    <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqPlanes">
                        <div class="accordion-body">
                            Los precios mostrados son finales e incluyen todos los impuestos aplicables.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logos de Pago -->
    <div class="row mt-5">
        <div class="col-12 text-center">
            <p class="text-muted">Pago seguro procesado por:</p>
            <img src="~/images/Cardnet-Web.png" alt="Cardnet" style="height: 50px;" class="me-3">
        </div>
    </div>
</div>

<!-- Modal Checkout -->
<div class="modal fade" id="modalCheckout" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: #00176B; color: white;">
                <h5 class="modal-title"><i class="fa fa-credit-card me-2"></i>Finalizar Compra</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Resumen del pedido -->
                    <div class="col-md-5">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5><i class="fa fa-receipt me-2"></i>Resumen del Pedido</h5>
                                <hr>
                                <p><strong>Plan:</strong> <span id="resumenPlan">-</span></p>
                                <p><strong>Período:</strong> 1 Año</p>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span>Subtotal:</span>
                                    <span id="resumenSubtotal">RD$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between text-muted">
                                    <span>ITBIS:</span>
                                    <span>Incluido</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong style="font-size: 1.2em;">Total:</strong>
                                    <strong style="font-size: 1.2em; color: #00176B;" id="resumenTotal">RD$0.00</strong>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <img src="~/images/Cardnet-Web.png" alt="Cardnet" style="height: 40px;">
                        </div>
                    </div>

                    <!-- Formulario de pago -->
                    <div class="col-md-7">
                        <h5><i class="fa fa-lock me-2"></i>Información de Pago Seguro</h5>
                        <p class="text-muted small">Tu información está protegida con encriptación SSL de 256 bits.</p>
                        <form id="formPago">
                            <input type="hidden" id="planId" value="">
                            <div class="mb-3">
                                <label class="form-label">Nombre en la Tarjeta *</label>
                                <input type="text" class="form-control" id="nombreTarjeta" required placeholder="Tal como aparece en la tarjeta">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Número de Tarjeta *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="numeroTarjeta" required maxlength="19" placeholder="0000 0000 0000 0000">
                                    <span class="input-group-text"><i class="fa fa-credit-card"></i></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Vencimiento *</label>
                                        <input type="text" class="form-control" id="vencimiento" required maxlength="5" placeholder="MM/AA">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">CVV *</label>
                                        <input type="password" class="form-control" id="cvv" required maxlength="4" placeholder="***">
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="chkTerminos" required>
                                <label class="form-check-label" for="chkTerminos">
                                    Acepto los <a href="/terminos" target="_blank">términos y condiciones</a> de servicio
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="chkAutorizacion" required>
                                <label class="form-check-label" for="chkAutorizacion">
                                    Autorizo el cargo a mi tarjeta de crédito/débito
                                </label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-lg" style="background: #00176B; color: white;" id="btnProcesarPago">
                    <i class="fa fa-lock me-2"></i>Pagar Ahora
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const API_BASE_URL = 'http://localhost:5015/api';
        var planSeleccionado = null;

        function getAuthToken() {
            return localStorage.getItem('accessToken');
        }

        function seleccionarPlan(planId, nombre, precio) {
            planSeleccionado = { id: planId, nombre: nombre, precio: precio };

            $('#planId').val(planId);
            $('#resumenPlan').text(nombre);
            $('#resumenSubtotal').text('RD$' + precio.toLocaleString('es-DO', { minimumFractionDigits: 2 }));
            $('#resumenTotal').text('RD$' + precio.toLocaleString('es-DO', { minimumFractionDigits: 2 }));

            $('#modalCheckout').modal('show');
        }

        $(document).ready(function () {
            // Cargar planes desde el backend (opcional para obtener precios actualizados)
            cargarPlanes();

            // Formatear número de tarjeta con espacios
            $('#numeroTarjeta').on('input', function () {
                var value = $(this).val().replace(/\D/g, '');
                var formatted = value.replace(/(.{4})/g, '$1 ').trim();
                $(this).val(formatted);
            });

            // Formatear vencimiento MM/AA
            $('#vencimiento').on('input', function () {
                var value = $(this).val().replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                $(this).val(value);
            });

            // Solo números para CVV
            $('#cvv').on('input', function () {
                var value = $(this).val().replace(/\D/g, '');
                $(this).val(value);
            });

            // Procesar pago
            $('#btnProcesarPago').on('click', procesarPago);
        });

        async function cargarPlanes() {
            const token = getAuthToken();
            // Los planes son públicos, no requieren token

            try {
                const response = await fetch(`${API_BASE_URL}/suscripciones/planes/empleadores`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const planes = await response.json();
                    console.log('Planes cargados desde backend:', planes);
                    // Los planes se pueden actualizar dinámicamente si es necesario
                }
            } catch (error) {
                console.log('Usando planes estáticos (backend no disponible)');
            }
        }

        async function procesarPago() {
            // Validaciones
            if (!$('#chkTerminos').is(':checked') || !$('#chkAutorizacion').is(':checked')) {
                Swal.fire('Error', 'Debe aceptar los términos y autorizar el cargo.', 'error');
                return;
            }

            var nombre = $('#nombreTarjeta').val().trim();
            var numero = $('#numeroTarjeta').val().replace(/\s/g, '');
            var vencimiento = $('#vencimiento').val();
            var cvv = $('#cvv').val();

            if (!nombre || !numero || !vencimiento || !cvv) {
                Swal.fire('Error', 'Por favor complete todos los campos.', 'error');
                return;
            }

            if (numero.length < 15 || numero.length > 16) {
                Swal.fire('Error', 'El número de tarjeta no es válido.', 'error');
                return;
            }

            if (cvv.length < 3) {
                Swal.fire('Error', 'El CVV debe tener al menos 3 dígitos.', 'error');
                return;
            }

            // Verificar formato MM/AA
            if (!/^\d{2}\/\d{2}$/.test(vencimiento)) {
                Swal.fire('Error', 'El formato de vencimiento debe ser MM/AA.', 'error');
                return;
            }

            // Mostrar procesando
            Swal.fire({
                title: 'Procesando pago...',
                html: '<div class="spinner-border" style="color: #00176B;" role="status"></div><br><br>Por favor no cierre esta ventana.<br><small>Conectando con Cardnet...</small>',
                allowOutsideClick: false,
                showConfirmButton: false
            });

            const token = getAuthToken();
            if (!token) {
                Swal.fire('Error', 'Sesión expirada. Por favor inicie sesión nuevamente.', 'error');
                window.location.href = '/Auth/Login';
                return;
            }

            try {
                // Preparar datos del pago
                const userId = localStorage.getItem('userId');
                const pagoData = {
                    planId: planSeleccionado.id,
                    nombreTarjeta: nombre,
                    numeroTarjeta: numero,
                    mesExpiracion: parseInt(vencimiento.split('/')[0]),
                    anioExpiracion: parseInt('20' + vencimiento.split('/')[1]),
                    cvv: cvv,
                    monto: planSeleccionado.precio
                };

                // Por ahora, crear la suscripción directamente
                // TODO: Integrar con Cardnet para procesar el pago real
                const suscripcionData = {
                    userId: userId,
                    planId: planSeleccionado.id,
                    tipoSuscripcion: 'Empleador',
                    mesesDuracion: 12
                };

                const response = await fetch(`${API_BASE_URL}/suscripciones`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(suscripcionData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error al crear la suscripción');
                }

                const result = await response.json();

                $('#modalCheckout').modal('hide');
                Swal.fire({
                    title: '¡Suscripción Activada!',
                    html: `<p>Tu suscripción al plan <strong>${planSeleccionado.nombre}</strong> ha sido activada correctamente.</p>
                           <p class="text-muted small">Tu plan estará activo por 12 meses.</p>`,
                    icon: 'success',
                    confirmButtonText: 'Continuar',
                    confirmButtonColor: '#00176B'
                }).then((result) => {
                    window.location.href = '/Empleador/Dashboard';
                });

            } catch (error) {
                console.error('Error procesando suscripción:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'No se pudo procesar la suscripción. Por favor intente nuevamente.',
                    icon: 'error',
                    confirmButtonColor: '#00176B'
                });
            }
        }
    </script>
}
