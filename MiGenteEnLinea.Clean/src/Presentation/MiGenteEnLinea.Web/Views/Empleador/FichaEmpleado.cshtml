@model dynamic
@{
    Layout = "~/Views/Shared/_LayoutEmpleador.cshtml";
    ViewData["Title"] = "Ficha de Empleado";
}

<style>
    .card-box {
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }
</style>

<div>
    <h2 id="NombreEmpleado" class="text-white">@ViewBag.NombreEmpleado</h2>

    <div class="bg-white pt-5 pb-5">
        <div class="container">
            <!-- Mensaje para empleado inactivo -->
            <div id="divMensajeInactivo" class="alert alert-light" style="display:none">
                <h4 class="alert-heading">Este empleado se encuentra desactivado</h4>
                <p>El empleado está desactivado y no puede realizar tareas en este momento. ¿Deseas imprimir el descargo?</p>
                <button id="btnImprimirDescargo" class="btn btn-primary">Imprimir Descargo</button>
            </div>

            <div class="row">
                <!-- Información del Empleado -->
                <div class="col-md-12 mt-1">
                    <div class="card-box">
                        <h4 class="card-title">Información del Empleado</h4>
                        <hr>
                        <div class="row">
                            <div class="col-md-3">
                                <p><strong>Fecha de Registro:</strong> <span id="fechaRegistro">@ViewBag.FechaRegistro</span></p>
                                <p><strong>Fecha de Inicio:</strong> <span id="fechaInicio">@ViewBag.FechaInicio</span></p>
                                <p><strong>Identificación:</strong> <span id="identificacion">@ViewBag.Identificacion</span></p>
                                <p><strong>Nombre:</strong> <span id="nombre">@ViewBag.NombreCompleto</span></p>
                                <p><strong>Salario:</strong> <span id="salario">@ViewBag.Salario</span></p>
                            </div>

                            <div class="col-md-3">
                                <p><strong>Dirección:</strong> <span id="htmlDireccion">@ViewBag.Direccion</span></p>
                                <p><strong>Provincia:</strong> <span id="htmlProvincia">@ViewBag.Provincia</span></p>
                                <p><strong>Municipio:</strong> <span id="htmlMunicipio">@ViewBag.Municipio</span></p>
                                <p><strong>Contacto Emergencia:</strong> <span id="htmlEmergencia">@ViewBag.ContactoEmergencia</span></p>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="chkTss" disabled @(ViewBag.AplicaTss ? "checked" : "") />
                                    <label class="form-check-label" for="chkTss">Aplica para deducciones TSS</label>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <p><strong>Teléfono 1:</strong> <span id="telefono1">@ViewBag.Telefono1</span></p>
                                <p><strong>Teléfono 2:</strong> <span id="telefono2">@ViewBag.Telefono2</span></p>
                                <p><strong>Período de Pago:</strong> <span id="periodoPago">@ViewBag.PeriodoPago</span></p>
                                <p><strong style="color:red">Contrato:</strong> <a href="#" id="btnContrato" class="btn btn-primary" style="color:white;font-weight:bold">Imprimir</a></p>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="chkActivo" disabled @(ViewBag.Activo ? "checked" : "") />
                                    <label class="form-check-label" for="chkActivo">Activo</label>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <img id="fotoEmpleado" src="@ViewBag.FotoUrl" alt="Foto" class="img-thumbnail" style="max-width: 200px;" />
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary me-2" id="btnEditarPerfil" type="button" data-toggle="modal" data-target="#registroEmpleadoModal">Editar</button>
                                <button type="button" class="btn btn-danger me-2" id="btnBaja" data-toggle="modal" data-target="#bajaEmpleadoModal">Dar de Baja</button>
                                <button class="btn btn-success me-2" type="button" id="btnPago" data-toggle="modal" data-target="#modalPago">Realizar Pago</button>
                                <button class="btn btn-info" type="button" id="btnNota" data-toggle="modal" data-target="#agregarNotaModal">Agregar Nota</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historial de Pagos -->
                <div class="col-md-12 mt-3">
                    <div class="card-box">
                        <h4 class="card-title">Historial de Pagos</h4>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="gridPagos">
                                <thead>
                                    <tr>
                                        <th>Fecha Registro</th>
                                        <th>Fecha Pago</th>
                                        <th>Tipo</th>
                                        <th>Monto</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyPagos">
                                    <!-- Se cargarán desde la API -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Historial de Notas -->
                <div class="col-md-12 mt-3">
                    <div class="card-box" style="height: 300px; overflow-y: auto;">
                        <h4 class="card-title">Historial de Notas</h4>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="gridNotas">
                                <thead>
                                    <tr>
                                        <th style="width: 15%;">Fecha</th>
                                        <th>Nota</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyNotas">
                                    <!-- Se cargarán desde la API -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Agregar Nota -->
<div class="modal fade" id="agregarNotaModal" tabindex="-1" aria-labelledby="agregarNotaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="agregarNotaModalLabel">Agregar Nota</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <textarea id="txtNota" class="form-control" maxlength="200" placeholder="Ingrese la nota" rows="4"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarNota">Guardar Nota</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Empleado -->
<div class="modal fade" id="registroEmpleadoModal" tabindex="-1" aria-labelledby="registroEmpleadoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registroEmpleadoModalLabel">Editar Empleado</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formEditarEmpleado">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editFechaInicio" class="form-label">Fecha de Inicio</label>
                                <input type="date" class="form-control" id="editFechaInicio" name="FechaInicio" readonly />
                            </div>

                            <div class="mb-3 text-center" id="divFoto" style="display: none;">
                                <img id="editFotoEmpleado" src="" width="200" class="img-thumbnail" />
                            </div>

                            <div class="mb-3">
                                <label for="editIdentificacion" class="form-label"># Identificación</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editIdentificacion" name="Identificacion" />
                                    <button type="button" class="btn btn-info" id="btnValidarCedula">Validar Cédula</button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="editNombre" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="editNombre" name="Nombre" required />
                            </div>

                            <div class="mb-3">
                                <label for="editApellido" class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="editApellido" name="Apellido" required />
                            </div>

                            <div class="mb-3">
                                <label for="editAlias" class="form-label">Alias/Apodo</label>
                                <input type="text" class="form-control" id="editAlias" name="Alias" />
                            </div>

                            <div class="mb-3">
                                <label for="editEstadoCivil" class="form-label">Estado Civil</label>
                                <select class="form-control" id="editEstadoCivil" name="EstadoCivil">
                                    <option value="1">Soltero(a)</option>
                                    <option value="2">Casado(a)</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="editNacimiento" class="form-label">Fecha de Nacimiento</label>
                                <input type="date" class="form-control" id="editNacimiento" name="FechaNacimiento" />
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDireccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="editDireccion" name="Direccion" maxlength="250" />
                            </div>

                            <div class="mb-3">
                                <label for="editProvincia" class="form-label">Provincia</label>
                                <input type="text" class="form-control" id="editProvincia" name="Provincia" />
                            </div>

                            <div class="mb-3">
                                <label for="editMunicipio" class="form-label">Municipio</label>
                                <input type="text" class="form-control" id="editMunicipio" name="Municipio" />
                            </div>

                            <div class="mb-3">
                                <label for="editTelefono1" class="form-label">Teléfono 1</label>
                                <input type="text" class="form-control" id="editTelefono1" name="Telefono1" />
                            </div>

                            <div class="mb-3">
                                <label for="editTelefono2" class="form-label">Teléfono 2</label>
                                <input type="text" class="form-control" id="editTelefono2" name="Telefono2" />
                            </div>

                            <div class="mb-3">
                                <label for="editPosicion" class="form-label">Posición que Ocupa</label>
                                <input type="text" class="form-control" id="editPosicion" name="Posicion" />
                            </div>

                            <div class="mb-3">
                                <label for="editSalario" class="form-label">Salario Bruto</label>
                                <input type="number" step="0.01" class="form-control" id="editSalario" name="Salario" placeholder="0.00" />
                            </div>
                        </div>
                    </div>

                    <hr />
                    <h5>Otras Remuneraciones</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Descripción 1</label>
                                <input type="text" class="form-control" name="Remuneracion1Nombre" id="editRem1Nombre" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Monto 1</label>
                                <input type="number" step="0.01" class="form-control" name="Remuneracion1Monto" id="editRem1Monto" placeholder="0.00" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Descripción 2</label>
                                <input type="text" class="form-control" name="Remuneracion2Nombre" id="editRem2Nombre" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Monto 2</label>
                                <input type="number" step="0.01" class="form-control" name="Remuneracion2Monto" id="editRem2Monto" placeholder="0.00" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Descripción 3</label>
                                <input type="text" class="form-control" name="Remuneracion3Nombre" id="editRem3Nombre" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Monto 3</label>
                                <input type="number" step="0.01" class="form-control" name="Remuneracion3Monto" id="editRem3Monto" placeholder="0.00" />
                            </div>
                        </div>
                    </div>

                    <hr />
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="editChkDeducciones" name="AplicaDeduccionesTSS" />
                                <label class="form-check-label" for="editChkDeducciones">Aplica para Deducciones TSS</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPeriodoPago" class="form-label">Periodo de Pago</label>
                                <select class="form-control" id="editPeriodoPago" name="PeriodoPago">
                                    <option value="1">Semanal</option>
                                    <option value="2">Quincenal</option>
                                    <option value="3">Mensual</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <hr />
                    <h5>Contacto de Emergencia</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editNombreContacto" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="editNombreContacto" name="ContactoEmergenciaNombre" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTelefonoContacto" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="editTelefonoContacto" name="ContactoEmergenciaTelefono" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Realizar Pago -->
<div class="modal fade" id="modalPago" tabindex="-1" aria-labelledby="modalPagoLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Realizar Pago a empleado</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formPago">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Concepto de Pago</label>
                            <select class="form-control" id="ddlConceptoPago" name="ConceptoPago">
                                <option value="1" selected>Pago de Salario</option>
                                <option value="2">Regalía Pascual</option>
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Fecha de Pago</label>
                            <input type="date" class="form-control" id="fechaPago" name="FechaPago" required style="width: 130px;" />
                        </div>

                        <div class="col-md-5 mb-3">
                            <label class="form-label">Tipo de Pago</label>
                            <select class="form-control" id="ddlTipoPago" name="TipoPago">
                                <option value="1" selected>Periodo Completo</option>
                                <option value="2">Fracción de Periodo</option>
                            </select>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label" style="color: white;">..</label>
                            <button type="button" class="btn btn-primary" id="btnContinuar">Continuar</button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-7 mb-3">
                            <label class="form-label">Descuento (Descripción)</label>
                            <input type="text" class="form-control" id="descripcionDescuento" name="DescripcionDescuento" />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Monto</label>
                            <input type="number" step="0.01" class="form-control" id="montoDescuento" name="MontoDescuento" placeholder="0.00" />
                        </div>

                        <div class="col-md-2 mb-3">
                            <label class="form-label" style="color: white;">..</label>
                            <button type="button" class="btn btn-danger" id="btnNuevoDescuento"><i class="fa fa-plus"></i></button>
                        </div>
                    </div>

                    <!-- Tabla de desglose del pago -->
                    <div id="divDesglose" style="display:none;">
                        <hr />
                        <h5>Desglose del Pago</h5>
                        <table class="table table-bordered">
                            <tbody id="tbodyDesglose">
                                <tr>
                                    <td>Salario Bruto</td>
                                    <td id="tdSalarioBruto">$0.00</td>
                                </tr>
                                <tr>
                                    <td>Otras Remuneraciones</td>
                                    <td id="tdRemuneraciones">$0.00</td>
                                </tr>
                                <tr>
                                    <td>Deducciones TSS</td>
                                    <td id="tdDeduccionesTss">$0.00</td>
                                </tr>
                                <tr>
                                    <td>Otros Descuentos</td>
                                    <td id="tdOtrosDescuentos">$0.00</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>Total a Pagar</strong></td>
                                    <td id="tdTotalPagar"><strong>$0.00</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-success" id="btnConfirmarPago">Confirmar Pago</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Dar de Baja -->
<div class="modal fade" id="bajaEmpleadoModal" tabindex="-1" aria-labelledby="bajaEmpleadoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bajaEmpleadoModalLabel">Dar de Baja Empleado</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="formBaja">
                <div class="modal-body">
                    <p class="text-danger"><strong>¿Está seguro de dar de baja a este empleado?</strong></p>
                    <p>Esta acción desactivará al empleado y generará su liquidación de prestaciones laborales.</p>
                    
                    <div class="mb-3">
                        <label for="fechaBaja" class="form-label">Fecha de Baja</label>
                        <input type="date" class="form-control" id="fechaBaja" name="FechaBaja" required />
                    </div>
                    
                    <div class="mb-3">
                        <label for="motivoBaja" class="form-label">Motivo de Baja</label>
                        <select class="form-control" id="motivoBaja" name="MotivoBaja">
                            <option value="1">Renuncia voluntaria</option>
                            <option value="2">Despido</option>
                            <option value="3">Fin de contrato</option>
                            <option value="4">Otro</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Confirmar Baja</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        var empleadoId = @(ViewBag.EmpleadoId ?? 0);

        $(document).ready(function () {
            if (empleadoId > 0) {
                loadEmpleadoData();
                loadPagos();
                loadNotas();
            }
        });

        function loadEmpleadoData() {
            // TODO: Cargar desde API
            // $.get('/api/empleados/' + empleadoId, function(data) { ... });
        }

        function loadPagos() {
            // TODO: Cargar historial de pagos desde API
        }

        function loadNotas() {
            // TODO: Cargar notas desde API
        }

        // Guardar nota
        $('#btnGuardarNota').click(function () {
            var nota = $('#txtNota').val();
            if (nota.trim() === '') {
                Swal.fire('Error', 'Ingrese una nota', 'error');
                return;
            }
            // TODO: Enviar a API
            Swal.fire('Éxito', 'Nota guardada correctamente', 'success');
            $('#agregarNotaModal').modal('hide');
            $('#txtNota').val('');
        });

        // Editar empleado
        $('#formEditarEmpleado').submit(function (e) {
            e.preventDefault();
            // TODO: Enviar a API
            Swal.fire('Éxito', 'Empleado actualizado correctamente', 'success');
            $('#registroEmpleadoModal').modal('hide');
        });

        // Continuar con pago
        $('#btnContinuar').click(function () {
            $('#divDesglose').show();
            // TODO: Calcular desglose desde API
        });

        // Confirmar pago
        $('#formPago').submit(function (e) {
            e.preventDefault();
            // TODO: Enviar pago a API
            Swal.fire('Éxito', 'Pago registrado correctamente', 'success');
            $('#modalPago').modal('hide');
        });

        // Dar de baja
        $('#formBaja').submit(function (e) {
            e.preventDefault();
            Swal.fire({
                title: '¿Confirmar baja?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, dar de baja',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // TODO: Enviar a API
                    Swal.fire('Completado', 'El empleado ha sido dado de baja', 'success');
                    $('#bajaEmpleadoModal').modal('hide');
                }
            });
        });

        // Imprimir contrato
        $('#btnContrato').click(function (e) {
            e.preventDefault();
            window.open('/Empleador/Contrato/' + empleadoId, '_blank');
        });

        // Imprimir descargo
        $('#btnImprimirDescargo').click(function () {
            window.open('/Empleador/Descargo/' + empleadoId, '_blank');
        });

        // Anular pago
        function anularPago(pagoId) {
            Swal.fire({
                title: '¿Anular este pago?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, anular',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // TODO: Enviar a API
                    Swal.fire('Anulado', 'El pago ha sido anulado', 'success');
                }
            });
        }

        // Imprimir recibo
        function imprimirRecibo(pagoId) {
            window.open('/Empleador/Recibo/' + pagoId, '_blank');
        }
    </script>
}
