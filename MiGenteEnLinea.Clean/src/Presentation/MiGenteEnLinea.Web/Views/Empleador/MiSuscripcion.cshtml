@{
    ViewData["Title"] = "Mi Suscripción";
    Layout = "_LayoutEmpleador";
}

<div class="container-fluid mt-4">
    <h2 style="color:white">Mi Suscripción</h2>
    <hr />
</div>

<div class="container-fluid bg-white p-4" style="border-radius: 5px;">
    <!-- Información del Plan Actual -->
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fa fa-star"></i> Plan Actual</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h3 id="nombrePlan" class="text-primary">Plan Básico</h3>
                            <p class="lead" id="descripcionPlan">Gestiona tu nómina de forma sencilla</p>
                            <hr>
                            <p><strong>Fecha de Inicio:</strong> <span id="fechaInicio">01/01/2024</span></p>
                            <p><strong>Próximo Pago:</strong> <span id="proximoPago" class="text-warning">01/01/2025</span></p>
                            <p><strong>Estado:</strong> <span class="badge bg-success" id="estadoPlan">Activo</span></p>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="display-1 text-primary">
                                <span id="precioPlan">RD$495</span>
                            </div>
                            <p class="text-muted">por año</p>
                            <hr>
                            <h5>Características:</h5>
                            <ul class="list-unstyled" id="caracteristicasPlan">
                                <li><i class="fa fa-check text-success"></i> 1 Usuario Administrador</li>
                                <li><i class="fa fa-check text-success"></i> 1 Empleado</li>
                                <li><i class="fa fa-check text-success"></i> Recibos de Pago</li>
                                <li><i class="fa fa-check text-success"></i> Contratos Laborales</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <a asp-controller="Empleador" asp-action="AdquirirPlan" class="btn btn-success">
                            <i class="fa fa-arrow-up"></i> Mejorar Plan
                        </a>
                        <button type="button" class="btn btn-outline-danger" id="btnCancelarSuscripcion">
                            <i class="fa fa-times"></i> Cancelar Suscripción
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fa fa-info-circle"></i> Resumen de Uso</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Empleados Registrados</label>
                        <div class="progress">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 50%;" id="barraEmpleados">1/2</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Usuarios de Consulta</label>
                        <div class="progress">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 0%;" id="barraUsuarios">0/0</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nóminas Procesadas (Este Mes)</label>
                        <div class="progress">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 10%;" id="barraNominas">1</div>
                        </div>
                    </div>
                    <hr>
                    <p class="text-muted small">
                        <i class="fa fa-lightbulb"></i> Si necesitas más empleados o usuarios, considera mejorar tu plan.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <!-- Historial de Facturación -->
    <h3><i class="fa fa-history"></i> Historial de Facturación</h3>
    <p class="text-muted">Revisa todos tus pagos y facturas anteriores.</p>

    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="gridPagos">
            <thead class="table-dark">
                <tr>
                    <th>Fecha</th>
                    <th>Descripción</th>
                    <th>Método de Pago</th>
                    <th>Monto</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>01/01/2024</td>
                    <td>Suscripción Anual - Plan Básico</td>
                    <td>Visa ****1234</td>
                    <td>RD$495.00</td>
                    <td><span class="badge bg-success">Pagado</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="verFactura(1)">
                            <i class="fa fa-file-pdf"></i> Ver Factura
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1">Anterior</a>
            </li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
                <a class="page-link" href="#">Siguiente</a>
            </li>
        </ul>
    </nav>

    <hr class="my-5">

    <!-- Métodos de Pago -->
    <h3><i class="fa fa-credit-card"></i> Métodos de Pago</h3>
    <p class="text-muted">Administra tus métodos de pago guardados.</p>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fa fa-credit-card fa-2x text-primary"></i>
                            <span class="ms-2">Visa ****1234</span>
                        </div>
                        <span class="badge bg-primary">Principal</span>
                    </div>
                    <p class="text-muted mt-2 mb-0">Vence: 12/2025</p>
                </div>
                <div class="card-footer">
                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarTarjeta(1)">
                        <i class="fa fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-dashed" style="border-style: dashed;">
                <div class="card-body text-center">
                    <button class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalAgregarTarjeta">
                        <i class="fa fa-plus"></i> Agregar Tarjeta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Agregar Tarjeta -->
<div class="modal fade" id="modalAgregarTarjeta" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Agregar Nueva Tarjeta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nombre en la Tarjeta</label>
                    <input type="text" class="form-control" id="nombreTarjeta" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Número de Tarjeta</label>
                    <input type="text" class="form-control" id="numeroTarjeta" maxlength="16" placeholder="0000 0000 0000 0000" required>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Fecha de Vencimiento</label>
                            <input type="text" class="form-control" id="vencimiento" placeholder="MM/AA" maxlength="5" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">CVV</label>
                            <input type="password" class="form-control" id="cvv" maxlength="4" required>
                        </div>
                    </div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="chkPrincipal">
                    <label class="form-check-label" for="chkPrincipal">Establecer como método de pago principal</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnGuardarTarjeta">
                    <i class="fa fa-save"></i> Guardar Tarjeta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cancelar Suscripción -->
<div class="modal fade" id="modalCancelarSuscripcion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Cancelar Suscripción</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger">
                    <i class="fa fa-exclamation-triangle"></i> 
                    <strong>¿Estás seguro que deseas cancelar tu suscripción?</strong>
                </p>
                <p>Al cancelar tu suscripción:</p>
                <ul>
                    <li>Perderás acceso a todas las funcionalidades al vencer tu período actual.</li>
                    <li>Tus datos se conservarán por 30 días adicionales.</li>
                    <li>Podrás reactivar tu cuenta en cualquier momento.</li>
                </ul>
                <div class="mb-3">
                    <label class="form-label">¿Por qué deseas cancelar?</label>
                    <select class="form-select" id="motivoCancelacion" required>
                        <option value="">-- Seleccione un motivo --</option>
                        <option value="precio">El precio es muy alto</option>
                        <option value="funcionalidades">No tiene las funcionalidades que necesito</option>
                        <option value="competencia">Encontré una mejor alternativa</option>
                        <option value="temporal">No lo necesito temporalmente</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="mb-3" id="divOtroMotivo" style="display:none;">
                    <label class="form-label">Especifique:</label>
                    <textarea class="form-control" id="otroMotivo" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, mantener mi suscripción</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarCancelacion">
                    <i class="fa fa-times"></i> Sí, cancelar suscripción
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const API_BASE_URL = API_BASE;
        let suscripcionActual = null;

        function getAuthToken() {
            return localStorage.getItem('accessToken');
        }

        // Mapeo de planes a nombres y características
        const planesInfo = {
            1: { nombre: 'Eres Mi Gente', precio: 495, empleados: 1, consulta: 0, nomina: false },
            2: { nombre: 'Somos Mi Gente', precio: 1695, empleados: 5, consulta: 1, nomina: false },
            3: { nombre: 'Mi Gente Somos Todos', precio: 3750, empleados: 15, consulta: 2, nomina: true }
        };

        $(document).ready(function() {
            // Cargar datos de suscripción desde API
            cargarSuscripcion();
            cargarHistorialPagos();
            
            // Mostrar modal de cancelación
            $('#btnCancelarSuscripcion').on('click', function() {
                $('#modalCancelarSuscripcion').modal('show');
            });
            
            // Toggle otro motivo
            $('#motivoCancelacion').on('change', function() {
                if ($(this).val() === 'otro') {
                    $('#divOtroMotivo').show();
                } else {
                    $('#divOtroMotivo').hide();
                }
            });
        });

        async function cargarSuscripcion() {
            const token = getAuthToken();
            const userId = localStorage.getItem('userId');
            
            if (!token || !userId) {
                console.log('No hay sesión activa');
                return;
            }

            try {
                const response = await authenticatedFetch(`/suscripciones/activa/${userId}`);

                if (response.status === 404) {
                    // No tiene suscripción
                    mostrarSinSuscripcion();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Error al cargar suscripción');
                }

                const suscripcion = await response.json();
                suscripcionActual = suscripcion;
                actualizarUISuscripcion(suscripcion);

            } catch (error) {
                console.error('Error cargando suscripción:', error);
                mostrarErrorSuscripcion();
            }
        }

        function actualizarUISuscripcion(suscripcion) {
            const plan = planesInfo[suscripcion.planId] || { nombre: `Plan ${suscripcion.planId}`, precio: 0 };
            
            // Actualizar nombre y precio del plan
            $('#nombrePlan').text(plan.nombre);
            $('#precioPlan').text('RD$' + plan.precio.toLocaleString('es-DO'));
            
            // Actualizar descripción según el plan
            const descripciones = {
                1: 'Plan básico para comenzar tu gestión de nómina',
                2: 'Ideal para pequeñas empresas con varios empleados',
                3: 'Solución completa con nómina TSS incluida'
            };
            $('#descripcionPlan').text(descripciones[suscripcion.planId] || '');

            // Formatear fechas
            const fechaInicio = new Date(suscripcion.fechaInicio);
            const fechaVencimiento = new Date(suscripcion.vencimiento);
            
            $('#fechaInicio').text(fechaInicio.toLocaleDateString('es-DO'));
            $('#proximoPago').text(fechaVencimiento.toLocaleDateString('es-DO'));

            // Actualizar estado
            if (suscripcion.cancelada) {
                $('#estadoPlan').removeClass('bg-success bg-warning').addClass('bg-danger').text('Cancelada');
            } else if (suscripcion.estaActiva) {
                if (suscripcion.diasRestantes <= 30) {
                    $('#estadoPlan').removeClass('bg-success bg-danger').addClass('bg-warning').text(`Activo (${suscripcion.diasRestantes} días)`);
                    $('#proximoPago').addClass('text-danger');
                } else {
                    $('#estadoPlan').removeClass('bg-warning bg-danger').addClass('bg-success').text('Activo');
                }
            } else {
                $('#estadoPlan').removeClass('bg-success bg-warning').addClass('bg-danger').text('Vencido');
            }

            // Actualizar características del plan
            const caracteristicas = `
                <li><i class="fa fa-check text-success"></i> 1 Usuario Administrador</li>
                <li><i class="fa fa-check text-success"></i> ${plan.empleados} Empleado${plan.empleados > 1 ? 's' : ''}</li>
                <li><i class="fa fa-check text-success"></i> Recibos de Pago</li>
                <li><i class="fa fa-check text-success"></i> Contratos Laborales</li>
                ${plan.consulta > 0 ? `<li><i class="fa fa-check text-success"></i> ${plan.consulta} Usuario${plan.consulta > 1 ? 's' : ''} de Consulta</li>` : ''}
                ${plan.nomina ? '<li><i class="fa fa-check text-success"></i> Nómina TSS</li>' : ''}
            `;
            $('#caracteristicasPlan').html(caracteristicas);

            // Cargar uso actual (empleados registrados)
            cargarUsoActual(plan.empleados);
        }

        async function cargarUsoActual(limiteEmpleados) {
            const token = getAuthToken();
            const userId = localStorage.getItem('userId');

            try {
                const response = await authenticatedFetch(`/empleados?userId=${userId}`);

                if (response.ok) {
                    const empleados = await response.json();
                    const total = Array.isArray(empleados) ? empleados.length : 0;
                    const porcentaje = limiteEmpleados > 0 ? (total / limiteEmpleados) * 100 : 0;
                    
                    $('#barraEmpleados')
                        .css('width', Math.min(porcentaje, 100) + '%')
                        .text(`${total}/${limiteEmpleados}`);
                    
                    if (porcentaje >= 90) {
                        $('#barraEmpleados').removeClass('bg-primary').addClass('bg-danger');
                    }
                }
            } catch (error) {
                console.log('Error cargando uso:', error);
            }
        }

        async function cargarHistorialPagos() {
            const token = getAuthToken();
            const userId = localStorage.getItem('userId');
            
            if (!token || !userId) return;

            try {
                const response = await authenticatedFetch(`/suscripciones/ventas/${userId}?pageSize=10`);

                if (!response.ok) {
                    throw new Error('Error al cargar historial');
                }

                const ventas = await response.json();
                actualizarTablaHistorial(ventas);

            } catch (error) {
                console.error('Error cargando historial:', error);
            }
        }

        function actualizarTablaHistorial(ventas) {
            const tbody = $('#gridPagos tbody');
            tbody.empty();

            if (!ventas || ventas.length === 0) {
                tbody.html('<tr><td colspan="6" class="text-center text-muted">No hay pagos registrados</td></tr>');
                return;
            }

            ventas.forEach(venta => {
                const fecha = new Date(venta.fechaTransaccion).toLocaleDateString('es-DO');
                const plan = planesInfo[venta.planId] || { nombre: `Plan ${venta.planId}` };
                
                // Determinar badge de estado
                let estadoBadge = '';
                switch (venta.estado) {
                    case 2: // Aprobado
                        estadoBadge = '<span class="badge bg-success">Pagado</span>';
                        break;
                    case 3: // Error
                        estadoBadge = '<span class="badge bg-warning">Error</span>';
                        break;
                    case 4: // Rechazado
                        estadoBadge = '<span class="badge bg-danger">Rechazado</span>';
                        break;
                    default:
                        estadoBadge = `<span class="badge bg-secondary">${venta.estadoTexto || 'Desconocido'}</span>`;
                }

                // Método de pago
                let metodoPago = venta.metodoPagoTexto || 'Tarjeta';
                if (venta.metodoReferencia) {
                    metodoPago += ` ****${venta.metodoReferencia.slice(-4)}`;
                }

                const row = `
                    <tr>
                        <td>${fecha}</td>
                        <td>Suscripción Anual - ${plan.nombre}</td>
                        <td>${metodoPago}</td>
                        <td>RD$${venta.precio.toLocaleString('es-DO', { minimumFractionDigits: 2 })}</td>
                        <td>${estadoBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="verFactura(${venta.ventaId})">
                                <i class="fa fa-file-pdf"></i> Ver
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function mostrarSinSuscripcion() {
            $('#nombrePlan').text('Sin Plan');
            $('#descripcionPlan').text('No tienes un plan activo');
            $('#estadoPlan').removeClass('bg-success').addClass('bg-secondary').text('Sin Plan');
            $('#precioPlan').text('RD$0');
        }

        function mostrarErrorSuscripcion() {
            Swal.fire('Error', 'No se pudo cargar la información de tu suscripción', 'error');
        }

        // Confirmar cancelación
        $('#btnConfirmarCancelacion').on('click', async function() {
            var motivo = $('#motivoCancelacion').val();
            var otroMotivo = $('#otroMotivo').val();
            
            if (!motivo) {
                Swal.fire('Error', 'Por favor seleccione un motivo de cancelación.', 'error');
                return;
            }

            const token = getAuthToken();
            const userId = localStorage.getItem('userId');
            
            if (!token || !userId) {
                Swal.fire('Error', 'Sesión expirada. Por favor inicie sesión nuevamente.', 'error');
                return;
            }

            try {
                const response = await authenticatedFetch(`/suscripciones/${userId}`, {
                    method: 'DELETE',
                    body: JSON.stringify({
                        userId: userId,
                        motivo: motivo === 'otro' ? otroMotivo : motivo
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al cancelar suscripción');
                }

                $('#modalCancelarSuscripcion').modal('hide');
                Swal.fire({
                    title: 'Suscripción Cancelada',
                    text: 'Tu suscripción ha sido cancelada. Tendrás acceso hasta el final de tu período actual.',
                    icon: 'info',
                    confirmButtonText: 'Entendido'
                }).then(() => {
                    cargarSuscripcion(); // Recargar datos
                });
            } catch (error) {
                console.error('Error cancelando suscripción:', error);
                Swal.fire('Error', 'No se pudo cancelar la suscripción. Intente nuevamente.', 'error');
            }
        });
        
        // Guardar tarjeta (funcionalidad futura)
        $('#btnGuardarTarjeta').on('click', function() {
            // Nota: La gestión de tarjetas guardadas requiere integración adicional con Cardnet
            $('#modalAgregarTarjeta').modal('hide');
            Swal.fire('Información', 'Esta funcionalidad estará disponible próximamente.', 'info');
        });
        
        function verFactura(facturaId) {
            // Abrir factura (implementar endpoint de factura PDF)
            Swal.fire({
                title: 'Factura #' + facturaId,
                text: 'La descarga de facturas estará disponible próximamente.',
                icon: 'info',
                confirmButtonText: 'Entendido'
            });
            // window.open('/Empleador/Factura/' + facturaId, '_blank');
        }
        
        function eliminarTarjeta(tarjetaId) {
            Swal.fire({
                title: '¿Eliminar tarjeta?',
                text: 'Esta acción no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Nota: Requiere integración adicional
                    Swal.fire('Información', 'Esta funcionalidad estará disponible próximamente.', 'info');
                }
            });
        }
    </script>
}
