@model dynamic
@{
    Layout = "~/Views/Shared/_LayoutEmpleador.cshtml";
    ViewData["Title"] = "Gestión de Nómina";
}

<h2 style="color:white">Administra la Nómina de tu Gente</h2>
<hr />

<div style="background-color:white; padding-block:5px; padding-left:10px;">
    <div class="container mt-5">
        <h2>Gestión de Nómina</h2>

        <!-- Tabs -->
        <ul class="nav nav-tabs mt-3" id="myTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="novedad-tab" data-toggle="tab" href="#novedad" role="tab" aria-controls="novedad" aria-selected="true">Novedad</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="historico-tab" data-toggle="tab" href="#historico" role="tab" aria-controls="historico" aria-selected="false">Histórico</a>
            </li>
        </ul>

        <!-- Contenido de los tabs -->
        <div class="tab-content mt-3" id="myTabContent">
            <!-- Tab Novedad -->
            <div class="tab-pane fade show active" id="novedad" role="tabpanel" aria-labelledby="novedad-tab">
                <div class="row">
                    <div class="container">
                        <div class="row mt-3">
                            <div class="col-md-2">
                                <label for="fechaPago" class="form-label">Fecha del Pago:</label>
                                <input type="date" class="form-control" id="fechaPago" name="FechaPago" />
                            </div>

                            <div class="col-md-3">
                                <label for="ddlEmpleado" class="form-label">Seleccionar Empleado:</label>
                                <select class="form-control" id="ddlEmpleado" name="EmpleadoId">
                                    <option value="">-- Seleccione --</option>
                                    <!-- Se cargarán desde la API -->
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label for="txtSalario" class="form-label">Salario:</label>
                                <input type="number" step="0.01" class="form-control" id="txtSalario" name="Salario" placeholder="0.00" onkeypress="return soloNumeros(event)" />
                            </div>

                            <div class="col-md-2">
                                <label for="txtDescuento" class="form-label">Descuento</label>
                                <input type="number" step="0.01" class="form-control" id="txtDescuento" name="Descuento" placeholder="0.00" />
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="txtDescripcion" class="form-label">Descripción del Descuento:</label>
                                <input type="text" class="form-control" id="txtDescripcion" name="DescripcionDescuento" />
                            </div>

                            <div class="col-md-4">
                                <label style="color:white">.</label>
                                <br />
                                <button type="button" class="btn btn-primary" id="btnAgregar">
                                    <i class="fa fa-plus"></i> Agregar
                                </button>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-12">
                                <h5>Pagos Pendientes</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered" id="gridNomina">
                                        <thead>
                                            <tr>
                                                <th>Empleado</th>
                                                <th>Fecha del Pago</th>
                                                <th>Monto</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyNomina">
                                            <!-- Se cargarán desde la API -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-12 text-right">
                                <button type="button" class="btn btn-success btn-lg" id="btnProcesarNomina">
                                    <i class="fa fa-check"></i> Procesar Nómina
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Histórico -->
            <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
                <div class="row mt-3">
                    <div class="col-md-3">
                        <label for="fechaDesde" class="form-label">Desde:</label>
                        <input type="date" class="form-control" id="fechaDesde" />
                    </div>
                    <div class="col-md-3">
                        <label for="fechaHasta" class="form-label">Hasta:</label>
                        <input type="date" class="form-control" id="fechaHasta" />
                    </div>
                    <div class="col-md-3">
                        <label style="color:white">.</label>
                        <br />
                        <button type="button" class="btn btn-primary" id="btnBuscar">
                            <i class="fa fa-search"></i> Buscar
                        </button>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>Historial de Pagos</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="gridHistorico">
                                <thead>
                                    <tr>
                                        <th>Fecha Pago</th>
                                        <th>Empleado</th>
                                        <th>Concepto</th>
                                        <th>Monto Bruto</th>
                                        <th>Deducciones</th>
                                        <th>Monto Neto</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyHistorico">
                                    <!-- Se cargarán desde la API -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <h6>Total Salarios Brutos:</h6>
                                        <h4 id="totalBruto">$0.00</h4>
                                    </div>
                                    <div class="col-md-3">
                                        <h6>Total Deducciones:</h6>
                                        <h4 id="totalDeducciones">$0.00</h4>
                                    </div>
                                    <div class="col-md-3">
                                        <h6>Total Pagado:</h6>
                                        <h4 id="totalPagado" class="text-success">$0.00</h4>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" class="btn btn-warning" id="btnExportar">
                                            <i class="fa fa-file-excel-o"></i> Exportar a Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            // Cargar lista de empleados
            loadEmpleados();
            
            // Establecer fecha de hoy
            var today = new Date().toISOString().split('T')[0];
            $('#fechaPago').val(today);
        });

        function loadEmpleados() {
            // TODO: Cargar desde API
            // $.get('/api/empleados', function(data) { ... });
        }

        function soloNumeros(event) {
            var charCode = (event.which) ? event.which : event.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57) && charCode !== 46) {
                return false;
            }
            return true;
        }

        // Cuando se selecciona un empleado, cargar su salario
        $('#ddlEmpleado').change(function () {
            var empleadoId = $(this).val();
            if (empleadoId) {
                // TODO: Cargar salario desde API
                // $.get('/api/empleados/' + empleadoId, function(data) {
                //     $('#txtSalario').val(data.salario);
                // });
            }
        });

        // Agregar a la nómina
        $('#btnAgregar').click(function () {
            var empleadoId = $('#ddlEmpleado').val();
            var empleadoNombre = $('#ddlEmpleado option:selected').text();
            var fechaPago = $('#fechaPago').val();
            var salario = $('#txtSalario').val();
            var descuento = $('#txtDescuento').val() || '0';

            if (!empleadoId || !fechaPago || !salario) {
                Swal.fire('Error', 'Complete todos los campos requeridos', 'error');
                return;
            }

            var montoNeto = parseFloat(salario) - parseFloat(descuento);

            var row = '<tr>' +
                '<td>' + empleadoNombre + '</td>' +
                '<td>' + fechaPago + '</td>' +
                '<td>$' + montoNeto.toFixed(2) + '</td>' +
                '<td>' +
                '<button type="button" class="btn btn-sm btn-success" onclick="verDetalle(this)">Ver</button> ' +
                '<button type="button" class="btn btn-sm btn-danger" onclick="eliminarFila(this)">Eliminar</button>' +
                '</td>' +
                '</tr>';

            $('#tbodyNomina').append(row);

            // Limpiar formulario
            $('#ddlEmpleado').val('');
            $('#txtSalario').val('');
            $('#txtDescuento').val('');
            $('#txtDescripcion').val('');
        });

        function eliminarFila(btn) {
            $(btn).closest('tr').remove();
        }

        function verDetalle(btn) {
            Swal.fire('Detalle', 'Aquí se mostrará el detalle del pago', 'info');
        }

        // Procesar nómina
        $('#btnProcesarNomina').click(function () {
            var rows = $('#tbodyNomina tr').length;
            if (rows === 0) {
                Swal.fire('Error', 'Agregue al menos un pago a la nómina', 'error');
                return;
            }

            Swal.fire({
                title: '¿Procesar Nómina?',
                text: 'Se procesarán ' + rows + ' pagos',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, procesar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // TODO: Enviar a API
                    Swal.fire('Éxito', 'Nómina procesada correctamente', 'success');
                    $('#tbodyNomina').empty();
                }
            });
        });

        // Buscar histórico
        $('#btnBuscar').click(function () {
            var desde = $('#fechaDesde').val();
            var hasta = $('#fechaHasta').val();

            if (!desde || !hasta) {
                Swal.fire('Error', 'Seleccione el rango de fechas', 'error');
                return;
            }

            // TODO: Cargar desde API
            Swal.fire('Info', 'Cargando histórico...', 'info');
        });

        // Exportar a Excel
        $('#btnExportar').click(function () {
            // TODO: Implementar exportación
            Swal.fire('Info', 'Exportando a Excel...', 'info');
        });

        // Anular pago
        function anularPago(pagoId) {
            Swal.fire({
                title: '¿Anular este pago?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, anular',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // TODO: Enviar a API
                    Swal.fire('Anulado', 'El pago ha sido anulado', 'success');
                }
            });
        }
    </script>
}
