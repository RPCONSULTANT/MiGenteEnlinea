@{
    ViewData["Title"] = "Mi Gente en Linea";
    Layout = "_LayoutEmpleador";
}

<style>
    .banner {
        position: relative;
        height: 500px;
        background: url("/images/bannerADM1.jpg");
        background-size: cover;
        background-position: unset;
    }
</style>

<link href="~/css/animated.css" rel="stylesheet" />

<!-- Stats Cards Row -->
<div class="row">
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
        <div class="card animate__animated animate__backInLeft">
            <div class="card-body p-3">
                <div class="row">
                    <div class="col-8">
                        <div class="numbers">
                            <p class="text-sm mb-0 text-uppercase font-weight-bold">Pagos</p>
                            <h5 id="lbPagos" class="font-weight-bolder">$0.00</h5>
                            <p class="mb-0">Historial de Pagos Realizados</p>
                        </div>
                    </div>
                    <div class="col-4 text-end">
                        <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                            <i class="ni ni-money-coins text-lg opacity-10" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
        <div class="card animate__animated animate__backInLeft">
            <div class="card-body p-3">
                <div class="row">
                    <div class="col-8">
                        <div class="numbers">
                            <p class="text-sm mb-0 text-uppercase font-weight-bold">Empleados</p>
                            <h5 id="lbEmpleados" class="font-weight-bolder">0</h5>
                            <p class="mb-0">Nomina Actual de Empleados</p>
                        </div>
                    </div>
                    <div class="col-4 text-end">
                        <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle">
                            <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
        <div class="card animate__animated animate__backInRight">
            <div class="card-body p-3">
                <div class="row">
                    <div class="col-8">
                        <div class="numbers">
                            <p class="text-sm mb-0 text-uppercase font-weight-bold">Consultas</p>
                            <h5 id="lbConsultas" class="font-weight-bolder">0</h5>
                            <p class="mb-0">
                                <span class="text-danger text-sm font-weight-bolder">-2%</span>
                                Perfiles Consultados
                            </p>
                        </div>
                    </div>
                    <div class="col-4 text-end">
                        <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                            <i class="ni ni-paper-diploma text-lg opacity-10" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="card animate__animated animate__backInRight">
            <div class="card-body p-3">
                <div class="row">
                    <div class="col-8">
                        <div class="numbers">
                            <p class="text-sm mb-0 text-uppercase font-weight-bold">Calificaciones</p>
                            <h5 id="lbCalificaciones" class="font-weight-bolder">0</h5>
                            <p class="mb-0">Calificaciones Completadas</p>
                        </div>
                    </div>
                    <div class="col-4 text-end">
                        <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">
                            <i class="ni ni-cart text-lg opacity-10" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Grids Row -->
<div class="row mt-4 animate__animated animate__bounceInUp">
    <div class="col-lg-7 mb-lg-0 mb-4">
        <div class="card">
            <div class="card-header pb-0 p-3">
                <div class="d-flex justify-content-between">
                    <h6 class="mb-2">Historial de Pagos</h6>
                </div>
            </div>
            <div class="card-body p-3">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Concepto</th>
                                <th>Monto</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPagos">
                            <tr>
                                <td colspan="4" class="text-center text-muted">No hay datos para mostrar</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card">
            <div class="card-header pb-0 p-3">
                <h6 class="mb-0">Ultimas Publicaciones</h6>
            </div>
            <div class="card-body p-3">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Titulo</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPublicaciones">
                            <tr>
                                <td colspan="2" class="text-center text-muted">No hay datos para mostrar</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Tipo de GestiÃ³n -->
<div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title" id="exampleModalLabel">Tipo de Gestion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <a asp-controller="Empleador" asp-action="Empleados" class="btn btn-primary btn-lg mb-3">Colaboradores Fijos</a>
                <a asp-controller="Empleador" asp-action="Contrataciones" class="btn btn-secondary btn-lg">Contrataciones Temporales</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const API_BASE_URL = API_BASE;

        function getAuthToken() {
            return localStorage.getItem('accessToken');
        }

        async function loadDashboardStats() {
            const token = getAuthToken();
            if (!token) {
                console.error('No auth token found');
                return;
            }

            const userId = localStorage.getItem('userId');

            try {
                // Load empleados count
                const empleadosResponse = await authenticatedFetch('/empleados');
                if (empleadosResponse.ok) {
                    const empleadosData = await empleadosResponse.json();
                    // API devuelve PaginatedList con .items, o array directo
                    const empleadosCount = empleadosData.totalCount || empleadosData.items?.length || empleadosData.length || 0;
                    document.getElementById('lbEmpleados').textContent = empleadosCount;
                }

                // Load ventas/pagos history
                if (userId) {
                    const ventasResponse = await authenticatedFetch(`/suscripciones/ventas/${userId}`);
                    if (ventasResponse.ok) {
                        const ventas = await ventasResponse.json();
                        const totalPagos = ventas.reduce((sum, v) => sum + (v.precio || 0), 0);
                        document.getElementById('lbPagos').textContent = `$${totalPagos.toLocaleString('es-DO', { minimumFractionDigits: 2 })}`;
                        
                        // Fill payments table
                        const tablaPagos = document.getElementById('tablaPagos');
                        if (ventas.length > 0) {
                            tablaPagos.innerHTML = ventas.slice(0, 5).map(v => `
                                <tr>
                                    <td>${v.fechaTransaccion ? new Date(v.fechaTransaccion).toLocaleDateString('es-DO') : '-'}</td>
                                    <td>Plan ${v.planId}</td>
                                    <td>$${(v.precio || 0).toLocaleString('es-DO', { minimumFractionDigits: 2 })}</td>
                                    <td><span class="badge bg-${v.estado === 2 ? 'success' : 'warning'}">${v.estadoTexto || (v.estado === 2 ? 'Aprobado' : 'Pendiente')}</span></td>
                                </tr>
                            `).join('');
                        }
                    }
                }

                // Load calificaciones hechas por este empleador
                if (userId) {
                    const calificacionesResponse = await authenticatedFetch(`/calificaciones/por-empleador/${userId}`);
                    if (calificacionesResponse.ok) {
                        const calificaciones = await calificacionesResponse.json();
                        document.getElementById('lbCalificaciones').textContent = calificaciones.length || 0;
                    } else {
                        // Fallback: usar todas las calificaciones
                        document.getElementById('lbCalificaciones').textContent = '0';
                    }
                }

                // Load consultas (perfiles consultados por este empleador)
                if (userId) {
                    const consultasResponse = await authenticatedFetch(`/consultas/count/${userId}`);
                    if (consultasResponse.ok) {
                        const consultasData = await consultasResponse.json();
                        document.getElementById('lbConsultas').textContent = consultasData.count || 0;
                    } else {
                        document.getElementById('lbConsultas').textContent = '0';
                    }
                } else {
                    document.getElementById('lbConsultas').textContent = '0';
                }

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Load stats on page load
        document.addEventListener('DOMContentLoaded', loadDashboardStats);
    </script>
}
